<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.7"/>
<title>External memory queue implementation</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
  $(window).load(resizeHeight);
</script>
<link href="madalgo-doxygen.css" rel="stylesheet" type="text/css"/>
<link href="printstyle.css" rel="stylesheet" type="text/css" media="print" />
</head>
<body>
<div id="top">
<div id="titlearea">
<h1 id="projectname">TPIE</h1>
<span class="version"><a href="//github.com/thomasmoelhave/tpie/tree/4739728">4739728</a></span>
</div>
<!-- Generated by Doxygen 1.8.17 -->
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',false,false,'search.php','Search');
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('queue.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">External memory queue implementation </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>Let us see how to implement an external memory (EM) queue using TPIE's files and streams. TPIE already has an EM queue implementation in <a class="el" href="classtpie_1_1queue.html">tpie::queue</a>, but this page will motivate the implementation and illustrate how to use <a class="el" href="classtpie_1_1file.html">tpie::file</a> and <a class="el" href="classtpie_1_1file_1_1stream.html">tpie::file::stream</a>.</p>
<p>For an EM queue we need a back buffer and a front buffer for items just enqueued and items to dequeue next, respectively. A <a class="el" href="classtpie_1_1file__stream.html">tpie::file_stream</a> is insufficient, since one would have to seek between the front and the back of the stream performing unnecessary block flushes and reads.</p>
<div class="fragment"><div class="line"><a class="code" href="classtpie_1_1file.html">tpie::file&lt;T&gt;</a> queue;</div>
<div class="line">queue.<a class="code" href="classtpie_1_1file__base__crtp.html#aaaa2b3843e0a1953fc353be95b51ff50">open</a>(); <span class="comment">// open anonymous temporary file for reading and writing</span></div>
<div class="line"><a class="code" href="classtpie_1_1file_1_1stream.html">tpie::file&lt;T&gt;::stream</a> front(queue);</div>
<div class="line"><a class="code" href="classtpie_1_1file_1_1stream.html">tpie::file&lt;T&gt;::stream</a> back(queue);</div>
<div class="line">tpie::stream_size_type enqueued = 0;</div>
</div><!-- fragment --><p>In the above code fragment, we associate two streams to one <a class="el" href="classtpie_1_1file.html" title="Central file abstraction.">tpie::file</a>. For each stream, TPIE allocates a block buffer, meaning the above code will have about twice the memory footprint compared to an ordinary <a class="el" href="classtpie_1_1file__stream.html" title="Compressed stream.">tpie::file_stream</a>. TPIE transparently shares buffers between streams whose file positions are in the same block, so we do not have to worry about blocks being flushed prematurely and data getting lost between streams. To count the number of items in the queue, we use a counter of type stream_size_type. This is significant on 32-bit platforms where a size_t or memory_size_type would overflow after 2**32 elements.</p>
<p>To enqueue and dequeue elements, we use the following two functions.</p>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> enqueue(<span class="keyword">const</span> T &amp; item) {</div>
<div class="line">    back.write(item);</div>
<div class="line">    ++enqueued;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">T dequeue() {</div>
<div class="line">    assert(enqueued &gt; 0);</div>
<div class="line">    --enqueued;</div>
<div class="line">    <span class="keywordflow">return</span> front.read();</div>
<div class="line">}</div>
</div><!-- fragment --><p>Recall that we used the zero-parameter open() of <a class="el" href="classtpie_1_1file.html" title="Central file abstraction.">tpie::file</a>, meaning the temporary file containing the contents of the queue will be deleted once our <a class="el" href="classtpie_1_1file.html" title="Central file abstraction.">tpie::file</a> is closed.</p>
<p>To implement an EM queue whose contents persist the lifetime of the <a class="el" href="classtpie_1_1file.html" title="Central file abstraction.">tpie::file</a>, we need to store the position of the front stream reader along with our file. (The back stream writer should always point to the end of the file, since we do not support popping from the back.) Luckily, this information can be stored with the file header using <em>TPIE user data</em>.</p>
<div class="fragment"><div class="line"><a class="code" href="classtpie_1_1file.html">tpie::file&lt;T&gt;</a> queue;</div>
<div class="line"><a class="code" href="classtpie_1_1file_1_1stream.html">tpie::file&lt;T&gt;::stream</a> front;</div>
<div class="line"><a class="code" href="classtpie_1_1file_1_1stream.html">tpie::file&lt;T&gt;::stream</a> back;</div>
<div class="line">tpie::stream_size_type enqueued;</div>
</div><!-- fragment --><p>Now, when opening the queue file, we need to specify the maximum user data size. We only need to store a stream_size_type, namely the offset of the front stream, so our maximum user data size will be sizeof(stream_size_type).</p>
<p>After opening, we need to check if user data has been written. If so, we use this as the offset of the front stream.</p>
<p>When closing the queue, we must remember to write the offset of the front stream.</p>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> open_queue(<a class="code" href="classtpie_1_1temp__file.html">tpie::temp_file</a> &amp; fileName) {</div>
<div class="line">    queue.<a class="code" href="classtpie_1_1file__base__crtp.html#aaaa2b3843e0a1953fc353be95b51ff50">open</a>(fileName, <a class="code" href="namespacetpie.html#ae4856303ae847dc340972edc10ae224dae38697bea10f1097bc4cdb06fbe487c6">tpie::access_read_write</a>, <span class="keyword">sizeof</span>(tpie::stream_size_type));</div>
<div class="line">    front.<a class="code" href="classtpie_1_1file_1_1stream.html#ab87165b74a3897714c68e6a8109b6518">attach</a>(queue);</div>
<div class="line">    back.<a class="code" href="classtpie_1_1file_1_1stream.html#ab87165b74a3897714c68e6a8109b6518">attach</a>(queue);</div>
<div class="line">    back.<a class="code" href="classtpie_1_1stream__crtp.html#a46b879efbf1ee99e1bf541838e41014d">seek</a>(0, tpie::file_base::stream::end);</div>
<div class="line">    enqueued = queue.size();</div>
<div class="line">    <span class="keywordflow">if</span> (queue.<a class="code" href="classtpie_1_1file__base__crtp.html#a5c87c471e25995ceb0dda35cbd78b23f">user_data_size</a>() &gt; 0) {</div>
<div class="line">        tpie::stream_size_type dequeued;</div>
<div class="line"> </div>
<div class="line">        queue.<a class="code" href="classtpie_1_1file__base__crtp.html#a2ad123840c915a84d41f836fd86c3362">read_user_data</a>(dequeued);</div>
<div class="line">        <span class="comment">// The above line is roughly equivalent to:</span></div>
<div class="line">        queue.<a class="code" href="classtpie_1_1file__base__crtp.html#a2ad123840c915a84d41f836fd86c3362">read_user_data</a>(&amp;dequeued, <span class="keyword">sizeof</span>(tpie::stream_size_type));</div>
<div class="line"> </div>
<div class="line">        front.<a class="code" href="classtpie_1_1stream__crtp.html#a46b879efbf1ee99e1bf541838e41014d">seek</a>(dequeued);</div>
<div class="line">        enqueued -= dequeued;</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">void</span> close_queue() {</div>
<div class="line">    queue.<a class="code" href="classtpie_1_1file__base__crtp.html#a076cb892998df3c3e3eb34ae11b8c553">write_user_data</a>(front.<a class="code" href="classtpie_1_1stream__crtp.html#a4cd74bc101cc789f93ca5dcc63e4639f">offset</a>());</div>
<div class="line">    front.<a class="code" href="classtpie_1_1file_1_1stream.html#adb3b48818906a6205861a137548c7df4">detach</a>();</div>
<div class="line">    back.<a class="code" href="classtpie_1_1file_1_1stream.html#adb3b48818906a6205861a137548c7df4">detach</a>();</div>
<div class="line">    queue.close();</div>
<div class="line">}</div>
</div><!-- fragment --><p><code>enqueue</code> and <code>dequeue</code> as above. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<div class="ttc" id="aclasstpie_1_1file_html"><div class="ttname"><a href="classtpie_1_1file.html">tpie::file</a></div><div class="ttdoc">Central file abstraction.</div><div class="ttdef"><b>Definition:</b> <a href="file_8h_source.html#l00039">file.h:39</a></div></div>
<div class="ttc" id="aclasstpie_1_1stream__crtp_html_a46b879efbf1ee99e1bf541838e41014d"><div class="ttname"><a href="classtpie_1_1stream__crtp.html#a46b879efbf1ee99e1bf541838e41014d">tpie::stream_crtp::seek</a></div><div class="ttdeci">void seek(stream_offset_type offset, offset_type whence=beginning)</div><div class="ttdoc">Moves the logical offset in the stream.</div><div class="ttdef"><b>Definition:</b> <a href="stream__crtp_8h_source.html#l00051">stream_crtp.h:51</a></div></div>
<div class="ttc" id="aclasstpie_1_1file_1_1stream_html_adb3b48818906a6205861a137548c7df4"><div class="ttname"><a href="classtpie_1_1file_1_1stream.html#adb3b48818906a6205861a137548c7df4">tpie::file::stream::detach</a></div><div class="ttdeci">void detach()</div><div class="ttdoc">Detach from a tpie::file.</div><div class="ttdef"><b>Definition:</b> <a href="file_8h_source.html#l00197">file.h:197</a></div></div>
<div class="ttc" id="aclasstpie_1_1file_1_1stream_html_ab87165b74a3897714c68e6a8109b6518"><div class="ttname"><a href="classtpie_1_1file_1_1stream.html#ab87165b74a3897714c68e6a8109b6518">tpie::file::stream::attach</a></div><div class="ttdeci">void attach(file &amp;f)</div><div class="ttdoc">Attach to the given tpie::file. If necessary, detach first.</div><div class="ttdef"><b>Definition:</b> <a href="file_8h_source.html#l00190">file.h:190</a></div></div>
<div class="ttc" id="aclasstpie_1_1file_1_1stream_html"><div class="ttname"><a href="classtpie_1_1file_1_1stream.html">tpie::file::stream</a></div><div class="ttdoc">Central stream abstraction.</div><div class="ttdef"><b>Definition:</b> <a href="file_8h_source.html#l00071">file.h:71</a></div></div>
<div class="ttc" id="aclasstpie_1_1file__base__crtp_html_a2ad123840c915a84d41f836fd86c3362"><div class="ttname"><a href="classtpie_1_1file__base__crtp.html#a2ad123840c915a84d41f836fd86c3362">tpie::file_base_crtp&lt; file_base &gt;::read_user_data</a></div><div class="ttdeci">void read_user_data(TT &amp;data)</div><div class="ttdoc">Read the user data associated with the file.</div><div class="ttdef"><b>Definition:</b> <a href="file__base__crtp_8h_source.html#l00126">file_base_crtp.h:126</a></div></div>
<div class="ttc" id="aclasstpie_1_1file__base__crtp_html_aaaa2b3843e0a1953fc353be95b51ff50"><div class="ttname"><a href="classtpie_1_1file__base__crtp.html#aaaa2b3843e0a1953fc353be95b51ff50">tpie::file_base_crtp&lt; file_base &gt;::open</a></div><div class="ttdeci">void open(const std::string &amp;path, access_type accessType=access_read_write, memory_size_type userDataSize=0, cache_hint cacheHint=access_sequential)</div><div class="ttdoc">Open a file.</div><div class="ttdef"><b>Definition:</b> <a href="file__base__crtp_8h_source.html#l00208">file_base_crtp.h:208</a></div></div>
<div class="ttc" id="aclasstpie_1_1file__base__crtp_html_a076cb892998df3c3e3eb34ae11b8c553"><div class="ttname"><a href="classtpie_1_1file__base__crtp.html#a076cb892998df3c3e3eb34ae11b8c553">tpie::file_base_crtp&lt; file_base &gt;::write_user_data</a></div><div class="ttdeci">void write_user_data(const TT &amp;data)</div><div class="ttdoc">Write user data to the stream.</div><div class="ttdef"><b>Definition:</b> <a href="file__base__crtp_8h_source.html#l00153">file_base_crtp.h:153</a></div></div>
<div class="ttc" id="aclasstpie_1_1file__base__crtp_html_a5c87c471e25995ceb0dda35cbd78b23f"><div class="ttname"><a href="classtpie_1_1file__base__crtp.html#a5c87c471e25995ceb0dda35cbd78b23f">tpie::file_base_crtp&lt; file_base &gt;::user_data_size</a></div><div class="ttdeci">memory_size_type user_data_size() const</div><div class="ttdoc">Get current user data size.</div><div class="ttdef"><b>Definition:</b> <a href="file__base__crtp_8h_source.html#l00176">file_base_crtp.h:176</a></div></div>
<div class="ttc" id="aclasstpie_1_1temp__file_html"><div class="ttname"><a href="classtpie_1_1temp__file.html">tpie::temp_file</a></div><div class="ttdoc">Class representing a reference to a temporary file.</div><div class="ttdef"><b>Definition:</b> <a href="tempname_8h_source.html#l00201">tempname.h:201</a></div></div>
<div class="ttc" id="anamespacetpie_html_ae4856303ae847dc340972edc10ae224dae38697bea10f1097bc4cdb06fbe487c6"><div class="ttname"><a href="namespacetpie.html#ae4856303ae847dc340972edc10ae224dae38697bea10f1097bc4cdb06fbe487c6">tpie::access_read_write</a></div><div class="ttdeci">@ access_read_write</div><div class="ttdoc">Open a file for reading or writing.</div><div class="ttdef"><b>Definition:</b> <a href="access__type_8h_source.html#l00035">access_type.h:35</a></div></div>
<div class="ttc" id="aclasstpie_1_1stream__crtp_html_a4cd74bc101cc789f93ca5dcc63e4639f"><div class="ttname"><a href="classtpie_1_1stream__crtp.html#a4cd74bc101cc789f93ca5dcc63e4639f">tpie::stream_crtp::offset</a></div><div class="ttdeci">stream_size_type offset() const</div><div class="ttdoc">Calculate the current offset in the stream.</div><div class="ttdef"><b>Definition:</b> <a href="stream__crtp_8h_source.html#l00091">stream_crtp.h:91</a></div></div>
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
      <li class="footer">from TPIE 4739728 (<a href="//github.com/thomasmoelhave/tpie/tree/4739728">browse source</a>). Generated on Mon May 23 2022 23:38:36 by
<a href="http://www.doxygen.org/index.html">Doxygen</a> 1.8.17 </li>
    </ul>
  </div>
</body>
</html>
