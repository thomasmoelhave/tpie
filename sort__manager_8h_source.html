<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.7"/>
<title>sort_manager.h Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
  $(window).load(resizeHeight);
</script>
<link href="madalgo-doxygen.css" rel="stylesheet" type="text/css"/>
<link href="printstyle.css" rel="stylesheet" type="text/css" media="print" />
</head>
<body>
<div id="top">
<div id="titlearea">
<h1 id="projectname">TPIE</h1>
<span class="version"><a href="//github.com/thomasmoelhave/tpie/tree/4739728">4739728</a></span>
</div>
<!-- Generated by Doxygen 1.8.17 -->
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',false,false,'search.php','Search');
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('sort__manager_8h_source.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<div class="header">
  <div class="headertitle">
<div class="title">sort_manager.h</div>  </div>
</div><!--header-->
<div class="contents">
<a href="sort__manager_8h.html">Go to the documentation of this file.</a><div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;<span class="comment">// -*- mode: c++; tab-width: 4; indent-tabs-mode: t; eval: (progn (c-set-style &quot;stroustrup&quot;) (c-set-offset &#39;innamespace 0)); -*-</span></div>
<div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;<span class="comment">// vi:set ts=4 sts=4 sw=4 noet :</span></div>
<div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;<span class="comment">// Copyright 2008, The TPIE development team</span></div>
<div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;<span class="comment">// </span></div>
<div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;<span class="comment">// This file is part of TPIE.</span></div>
<div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;<span class="comment">// </span></div>
<div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;<span class="comment">// TPIE is free software: you can redistribute it and/or modify it under</span></div>
<div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;<span class="comment">// the terms of the GNU Lesser General Public License as published by the</span></div>
<div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;<span class="comment">// Free Software Foundation, either version 3 of the License, or (at your</span></div>
<div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;<span class="comment">// option) any later version.</span></div>
<div class="line"><a name="l00011"></a><span class="lineno">   11</span>&#160;<span class="comment">// </span></div>
<div class="line"><a name="l00012"></a><span class="lineno">   12</span>&#160;<span class="comment">// TPIE is distributed in the hope that it will be useful, but WITHOUT ANY</span></div>
<div class="line"><a name="l00013"></a><span class="lineno">   13</span>&#160;<span class="comment">// WARRANTY; without even the implied warranty of MERCHANTABILITY or</span></div>
<div class="line"><a name="l00014"></a><span class="lineno">   14</span>&#160;<span class="comment">// FITNESS FOR A PARTICULAR PURPOSE.  See the GNU Lesser General Public</span></div>
<div class="line"><a name="l00015"></a><span class="lineno">   15</span>&#160;<span class="comment">// License for more details.</span></div>
<div class="line"><a name="l00016"></a><span class="lineno">   16</span>&#160;<span class="comment">// </span></div>
<div class="line"><a name="l00017"></a><span class="lineno">   17</span>&#160;<span class="comment">// You should have received a copy of the GNU Lesser General Public License</span></div>
<div class="line"><a name="l00018"></a><span class="lineno">   18</span>&#160;<span class="comment">// along with TPIE.  If not, see &lt;http://www.gnu.org/licenses/&gt;</span></div>
<div class="line"><a name="l00019"></a><span class="lineno">   19</span>&#160; </div>
<div class="line"><a name="l00027"></a><span class="lineno">   27</span>&#160; </div>
<div class="line"><a name="l00028"></a><span class="lineno">   28</span>&#160;<span class="preprocessor">#ifndef _TPIE_AMI_SORT_MANAGER_H</span></div>
<div class="line"><a name="l00029"></a><span class="lineno">   29</span>&#160;<span class="preprocessor">#define _TPIE_AMI_SORT_MANAGER_H</span></div>
<div class="line"><a name="l00030"></a><span class="lineno">   30</span>&#160; </div>
<div class="line"><a name="l00031"></a><span class="lineno">   31</span>&#160;<span class="comment">// Get definitions for working with Unix and Windows</span></div>
<div class="line"><a name="l00032"></a><span class="lineno">   32</span>&#160;<span class="preprocessor">#include &lt;<a class="code" href="portability_8h.html">tpie/portability.h</a>&gt;</span></div>
<div class="line"><a name="l00033"></a><span class="lineno">   33</span>&#160;<span class="preprocessor">#include &lt;tpie/stream.h&gt;</span> </div>
<div class="line"><a name="l00034"></a><span class="lineno">   34</span>&#160;<span class="preprocessor">#include &lt;<a class="code" href="tempname_8h.html">tpie/tempname.h</a>&gt;</span></div>
<div class="line"><a name="l00035"></a><span class="lineno">   35</span>&#160;<span class="preprocessor">#include &lt;<a class="code" href="array_8h.html">tpie/array.h</a>&gt;</span></div>
<div class="line"><a name="l00036"></a><span class="lineno">   36</span>&#160;<span class="preprocessor">#include &lt;<a class="code" href="merge__sorted__runs_8h.html">tpie/merge_sorted_runs.h</a>&gt;</span></div>
<div class="line"><a name="l00037"></a><span class="lineno">   37</span>&#160;<span class="preprocessor">#include &lt;<a class="code" href="mergeheap_8h.html">tpie/mergeheap.h</a>&gt;</span>  <span class="comment">//For templated heaps</span></div>
<div class="line"><a name="l00038"></a><span class="lineno">   38</span>&#160;<span class="preprocessor">#include &lt;<a class="code" href="internal__sort_8h.html">tpie/internal_sort.h</a>&gt;</span> <span class="comment">// Contains classes for sorting internal runs</span></div>
<div class="line"><a name="l00039"></a><span class="lineno">   39</span>&#160;<span class="comment">// using different comparison types</span></div>
<div class="line"><a name="l00040"></a><span class="lineno">   40</span>&#160;<span class="preprocessor">#include &lt;cmath&gt;</span> <span class="comment">//for log, ceil, etc.</span></div>
<div class="line"><a name="l00041"></a><span class="lineno">   41</span>&#160;<span class="preprocessor">#include &lt;string&gt;</span></div>
<div class="line"><a name="l00042"></a><span class="lineno">   42</span>&#160;<span class="preprocessor">#include &lt;filesystem&gt;</span></div>
<div class="line"><a name="l00043"></a><span class="lineno">   43</span>&#160; </div>
<div class="line"><a name="l00044"></a><span class="lineno">   44</span>&#160;<span class="preprocessor">#include &lt;<a class="code" href="progress__indicator__base_8h.html">tpie/progress_indicator_base.h</a>&gt;</span></div>
<div class="line"><a name="l00045"></a><span class="lineno">   45</span>&#160; </div>
<div class="line"><a name="l00046"></a><span class="lineno">   46</span>&#160;<span class="preprocessor">#include &lt;<a class="code" href="tpie__assert_8h.html">tpie/tpie_assert.h</a>&gt;</span></div>
<div class="line"><a name="l00047"></a><span class="lineno">   47</span>&#160; </div>
<div class="line"><a name="l00048"></a><span class="lineno">   48</span>&#160;<span class="keyword">namespace </span><a class="code" href="namespacetpie.html">tpie</a> {</div>
<div class="line"><a name="l00049"></a><span class="lineno">   49</span>&#160; </div>
<div class="line"><a name="l00051"></a><span class="lineno"><a class="line" href="namespacetpie.html#a90b015a1fcd16bdca3002ce6f6fe89eb">   51</a></span>&#160;<span class="keyword">typedef</span> TPIE_OS_SIZE_T <a class="code" href="namespacetpie.html#a90b015a1fcd16bdca3002ce6f6fe89eb">arity_t</a>;</div>
<div class="line"><a name="l00052"></a><span class="lineno">   52</span>&#160; </div>
<div class="line"><a name="l00058"></a><span class="lineno">   58</span>&#160; </div>
<div class="line"><a name="l00059"></a><span class="lineno">   59</span>&#160;<span class="keyword">template</span> &lt;<span class="keyword">class</span> T, <span class="keyword">class</span> I, <span class="keyword">class</span> M&gt;</div>
<div class="line"><a name="l00060"></a><span class="lineno"><a class="line" href="classtpie_1_1sort__manager.html">   60</a></span>&#160;<span class="keyword">class </span><a class="code" href="classtpie_1_1sort__manager.html">sort_manager</a> {</div>
<div class="line"><a name="l00061"></a><span class="lineno">   61</span>&#160;        </div>
<div class="line"><a name="l00062"></a><span class="lineno">   62</span>&#160;<span class="keyword">public</span>:</div>
<div class="line"><a name="l00063"></a><span class="lineno">   63</span>&#160;    <a class="code" href="classtpie_1_1sort__manager.html">sort_manager</a>(I* isort, M* mheap);</div>
<div class="line"><a name="l00064"></a><span class="lineno">   64</span>&#160; </div>
<div class="line"><a name="l00065"></a><span class="lineno">   65</span>&#160;    ~<a class="code" href="classtpie_1_1sort__manager.html">sort_manager</a>() {</div>
<div class="line"><a name="l00066"></a><span class="lineno">   66</span>&#160;        <span class="comment">//  No code in this destructor.</span></div>
<div class="line"><a name="l00067"></a><span class="lineno">   67</span>&#160;    };</div>
<div class="line"><a name="l00068"></a><span class="lineno">   68</span>&#160; </div>
<div class="line"><a name="l00072"></a><span class="lineno">   72</span>&#160;    <span class="keywordtype">void</span> <a class="code" href="classtpie_1_1sort__manager.html#ad5cabd9a2f649c29dc7cdf95c39e271b">sort</a>(<a class="code" href="classtpie_1_1file__stream.html">file_stream&lt;T&gt;</a>* in, <a class="code" href="classtpie_1_1file__stream.html">file_stream&lt;T&gt;</a>* out, </div>
<div class="line"><a name="l00073"></a><span class="lineno">   73</span>&#160;              <a class="code" href="classtpie_1_1progress__indicator__base.html">progress_indicator_base</a>* indicator = NULL);</div>
<div class="line"><a name="l00074"></a><span class="lineno">   74</span>&#160; </div>
<div class="line"><a name="l00079"></a><span class="lineno">   79</span>&#160;    <span class="keywordtype">void</span> <a class="code" href="classtpie_1_1sort__manager.html#ad5cabd9a2f649c29dc7cdf95c39e271b">sort</a>(<a class="code" href="classtpie_1_1file__stream.html">file_stream&lt;T&gt;</a>* in, <a class="code" href="classtpie_1_1progress__indicator__base.html">progress_indicator_base</a>* indicator = NULL); </div>
<div class="line"><a name="l00080"></a><span class="lineno">   80</span>&#160;        </div>
<div class="line"><a name="l00081"></a><span class="lineno">   81</span>&#160;<span class="keyword">private</span>:</div>
<div class="line"><a name="l00082"></a><span class="lineno">   82</span>&#160;    <span class="comment">// *************</span></div>
<div class="line"><a name="l00083"></a><span class="lineno">   83</span>&#160;    <span class="comment">// * Functions *</span></div>
<div class="line"><a name="l00084"></a><span class="lineno">   84</span>&#160;    <span class="comment">// *************</span></div>
<div class="line"><a name="l00085"></a><span class="lineno">   85</span>&#160;        </div>
<div class="line"><a name="l00086"></a><span class="lineno">   86</span>&#160;    <span class="keywordtype">void</span> start_sort();              <span class="comment">// high level wrapper to full sort </span></div>
<div class="line"><a name="l00087"></a><span class="lineno">   87</span>&#160;    <span class="keywordtype">void</span> compute_sort_params();     <span class="comment">// compute nInputItems, mrgArity, nRuns</span></div>
<div class="line"><a name="l00088"></a><span class="lineno">   88</span>&#160;    <span class="keywordtype">void</span> partition_and_sort_runs(<a class="code" href="classtpie_1_1progress__indicator__base.html">progress_indicator_base</a>* indicator, <a class="code" href="classtpie_1_1array.html">tpie::array&lt;temp_file&gt;</a> &amp; temporaries); <span class="comment">// make initial sorted runs</span></div>
<div class="line"><a name="l00089"></a><span class="lineno">   89</span>&#160;    <span class="keywordtype">void</span> merge_to_output(<a class="code" href="classtpie_1_1progress__indicator__base.html">progress_indicator_base</a>* indicator, <a class="code" href="classtpie_1_1array.html">tpie::array&lt;temp_file&gt;</a> &amp; temporaries); <span class="comment">// loop over merge tree, create output stream</span></div>
<div class="line"><a name="l00090"></a><span class="lineno">   90</span>&#160;    <span class="comment">// Merge a single group mrgArity streams to an output stream</span></div>
<div class="line"><a name="l00091"></a><span class="lineno">   91</span>&#160;    <span class="keywordtype">void</span> single_merge(</div>
<div class="line"><a name="l00092"></a><span class="lineno">   92</span>&#160;        <span class="keyword">typename</span> <a class="code" href="classtpie_1_1array.html">tpie::array</a>&lt;<a class="code" href="namespacetpie.html#abeaddf0be84ea6bc461a97d5ebe184bd">tpie::unique_ptr</a>&lt;<a class="code" href="classtpie_1_1file__stream.html">file_stream&lt;T&gt;</a> &gt; &gt;::iterator,</div>
<div class="line"><a name="l00093"></a><span class="lineno">   93</span>&#160;        <span class="keyword">typename</span> <a class="code" href="classtpie_1_1array.html">tpie::array</a>&lt;<a class="code" href="namespacetpie.html#abeaddf0be84ea6bc461a97d5ebe184bd">tpie::unique_ptr</a>&lt;<a class="code" href="classtpie_1_1file__stream.html">file_stream&lt;T&gt;</a> &gt; &gt;::iterator,</div>
<div class="line"><a name="l00094"></a><span class="lineno">   94</span>&#160;        <a class="code" href="classtpie_1_1file__stream.html">file_stream&lt;T&gt;</a>*, TPIE_OS_OFFSET = -1, <a class="code" href="classtpie_1_1progress__indicator__base.html">progress_indicator_base</a>* indicator=0);</div>
<div class="line"><a name="l00095"></a><span class="lineno">   95</span>&#160;        </div>
<div class="line"><a name="l00096"></a><span class="lineno">   96</span>&#160;    <span class="comment">// **************</span></div>
<div class="line"><a name="l00097"></a><span class="lineno">   97</span>&#160;    <span class="comment">// * Attributes *</span></div>
<div class="line"><a name="l00098"></a><span class="lineno">   98</span>&#160;    <span class="comment">// **************</span></div>
<div class="line"><a name="l00099"></a><span class="lineno">   99</span>&#160;        </div>
<div class="line"><a name="l00100"></a><span class="lineno">  100</span>&#160;    I*              m_internalSorter;   <span class="comment">// Method for sorting runs in memory</span></div>
<div class="line"><a name="l00101"></a><span class="lineno">  101</span>&#160;    M*              m_mergeHeap;        <span class="comment">// Merge heap implementation </span></div>
<div class="line"><a name="l00102"></a><span class="lineno">  102</span>&#160;    <a class="code" href="classtpie_1_1file__stream.html">file_stream&lt;T&gt;</a>* inStream;   </div>
<div class="line"><a name="l00103"></a><span class="lineno">  103</span>&#160;    <a class="code" href="classtpie_1_1file__stream.html">file_stream&lt;T&gt;</a>* outStream;   </div>
<div class="line"><a name="l00104"></a><span class="lineno">  104</span>&#160;    TPIE_OS_OFFSET  nInputItems;        <span class="comment">// Number of items in inStream;</span></div>
<div class="line"><a name="l00105"></a><span class="lineno">  105</span>&#160;    TPIE_OS_SIZE_T  mmBytesAvail;       <span class="comment">// Amount of spare memory we can use</span></div>
<div class="line"><a name="l00106"></a><span class="lineno">  106</span>&#160;    TPIE_OS_SIZE_T  mmBytesPerStream;   <span class="comment">// Memory consumed by each Stream obj</span></div>
<div class="line"><a name="l00107"></a><span class="lineno">  107</span>&#160;        </div>
<div class="line"><a name="l00108"></a><span class="lineno">  108</span>&#160;    <a class="code" href="classtpie_1_1progress__indicator__base.html">progress_indicator_base</a>* m_indicator; <span class="comment">// pointer to progress indicator</span></div>
<div class="line"><a name="l00109"></a><span class="lineno">  109</span>&#160; </div>
<div class="line"><a name="l00110"></a><span class="lineno">  110</span>&#160;    TPIE_OS_OFFSET progCount; <span class="comment">//counter for showing progress</span></div>
<div class="line"><a name="l00111"></a><span class="lineno">  111</span>&#160;        </div>
<div class="line"><a name="l00112"></a><span class="lineno">  112</span>&#160;    <span class="keywordtype">bool</span> use2xSpace; <span class="comment">//flag to indicate if we are doing a 2x sort</span></div>
<div class="line"><a name="l00113"></a><span class="lineno">  113</span>&#160;        </div>
<div class="line"><a name="l00114"></a><span class="lineno">  114</span>&#160;    <span class="comment">// The maximum number of stream items of type T that we can</span></div>
<div class="line"><a name="l00115"></a><span class="lineno">  115</span>&#160;    <span class="comment">// sort in internal memory</span></div>
<div class="line"><a name="l00116"></a><span class="lineno">  116</span>&#160;    TPIE_OS_SIZE_T nItemsPerRun;</div>
<div class="line"><a name="l00117"></a><span class="lineno">  117</span>&#160;        </div>
<div class="line"><a name="l00118"></a><span class="lineno">  118</span>&#160;    TPIE_OS_OFFSET nRuns; <span class="comment">//The number of sorted runs left to merge</span></div>
<div class="line"><a name="l00119"></a><span class="lineno">  119</span>&#160;    <a class="code" href="namespacetpie.html#a90b015a1fcd16bdca3002ce6f6fe89eb">arity_t</a> mrgArity; <span class="comment">//Max runs we can merge at one time</span></div>
<div class="line"><a name="l00120"></a><span class="lineno">  120</span>&#160;        </div>
<div class="line"><a name="l00121"></a><span class="lineno">  121</span>&#160;    <span class="comment">// The output stream to which we are currently writing runs</span></div>
<div class="line"><a name="l00122"></a><span class="lineno">  122</span>&#160;    <a class="code" href="classtpie_1_1file__stream.html">file_stream&lt;T&gt;</a>* curOutputRunStream;</div>
<div class="line"><a name="l00123"></a><span class="lineno">  123</span>&#160;        </div>
<div class="line"><a name="l00124"></a><span class="lineno">  124</span>&#160;    <span class="comment">// The mininum number of runs in each output stream</span></div>
<div class="line"><a name="l00125"></a><span class="lineno">  125</span>&#160;    <span class="comment">// some streams can have one additional run</span></div>
<div class="line"><a name="l00126"></a><span class="lineno">  126</span>&#160;    TPIE_OS_OFFSET minRunsPerStream; </div>
<div class="line"><a name="l00127"></a><span class="lineno">  127</span>&#160;    <span class="comment">// The number of extra runs or the number of streams that</span></div>
<div class="line"><a name="l00128"></a><span class="lineno">  128</span>&#160;    <span class="comment">// get one additional run.</span></div>
<div class="line"><a name="l00129"></a><span class="lineno">  129</span>&#160;    <a class="code" href="namespacetpie.html#a90b015a1fcd16bdca3002ce6f6fe89eb">arity_t</a> nXtraRuns;</div>
<div class="line"><a name="l00130"></a><span class="lineno">  130</span>&#160;    </div>
<div class="line"><a name="l00131"></a><span class="lineno">  131</span>&#160;    <span class="comment">// The last run can have fewer than nItemsPerRun;</span></div>
<div class="line"><a name="l00132"></a><span class="lineno">  132</span>&#160;    TPIE_OS_SIZE_T nItemsInLastRun;</div>
<div class="line"><a name="l00133"></a><span class="lineno">  133</span>&#160;    <span class="comment">// How many items we will sort in a given run</span></div>
<div class="line"><a name="l00134"></a><span class="lineno">  134</span>&#160;    TPIE_OS_SIZE_T nItemsInThisRun;</div>
<div class="line"><a name="l00135"></a><span class="lineno">  135</span>&#160;    <span class="comment">// For each output stream, how many runs it should get</span></div>
<div class="line"><a name="l00136"></a><span class="lineno">  136</span>&#160;    TPIE_OS_OFFSET runsInStream;</div>
<div class="line"><a name="l00137"></a><span class="lineno">  137</span>&#160;        </div>
<div class="line"><a name="l00138"></a><span class="lineno">  138</span>&#160;    <span class="comment">// A buffer for building the output file names</span></div>
<div class="line"><a name="l00139"></a><span class="lineno">  139</span>&#160;    std::string   newName;</div>
<div class="line"><a name="l00140"></a><span class="lineno">  140</span>&#160; </div>
<div class="line"><a name="l00141"></a><span class="lineno">  141</span>&#160;    <span class="comment">//prefix of temp files created during sort</span></div>
<div class="line"><a name="l00142"></a><span class="lineno">  142</span>&#160;    std::string working_disk;</div>
<div class="line"><a name="l00143"></a><span class="lineno">  143</span>&#160; </div>
<div class="line"><a name="l00144"></a><span class="lineno">  144</span>&#160;<span class="keyword">private</span>:</div>
<div class="line"><a name="l00145"></a><span class="lineno">  145</span>&#160;    <a class="code" href="classtpie_1_1sort__manager.html">sort_manager</a>(<span class="keyword">const</span> <a class="code" href="classtpie_1_1sort__manager.html">sort_manager&lt;T,I,M&gt;</a>&amp; other);</div>
<div class="line"><a name="l00146"></a><span class="lineno">  146</span>&#160;    <a class="code" href="classtpie_1_1sort__manager.html">sort_manager&lt;T,I,M&gt;</a>&amp; operator=(<span class="keyword">const</span> <a class="code" href="classtpie_1_1sort__manager.html">sort_manager&lt;T,I,M&gt;</a>&amp; other);</div>
<div class="line"><a name="l00147"></a><span class="lineno">  147</span>&#160;};</div>
<div class="line"><a name="l00148"></a><span class="lineno">  148</span>&#160;    </div>
<div class="line"><a name="l00149"></a><span class="lineno">  149</span>&#160;<span class="keyword">template</span> &lt;<span class="keyword">class</span> T, <span class="keyword">class</span> I, <span class="keyword">class</span> M&gt;</div>
<div class="line"><a name="l00150"></a><span class="lineno">  150</span>&#160;<a class="code" href="classtpie_1_1sort__manager.html">sort_manager&lt;T, I, M&gt;::sort_manager</a>(I* isort, M* mheap):</div>
<div class="line"><a name="l00151"></a><span class="lineno">  151</span>&#160;    m_internalSorter(isort), </div>
<div class="line"><a name="l00152"></a><span class="lineno">  152</span>&#160;    m_mergeHeap(mheap),</div>
<div class="line"><a name="l00153"></a><span class="lineno">  153</span>&#160;    inStream(0), </div>
<div class="line"><a name="l00154"></a><span class="lineno">  154</span>&#160;    outStream(0),</div>
<div class="line"><a name="l00155"></a><span class="lineno">  155</span>&#160;    nInputItems(0),</div>
<div class="line"><a name="l00156"></a><span class="lineno">  156</span>&#160;    mmBytesAvail(0),</div>
<div class="line"><a name="l00157"></a><span class="lineno">  157</span>&#160;    mmBytesPerStream(0),</div>
<div class="line"><a name="l00158"></a><span class="lineno">  158</span>&#160;    m_indicator(NULL),</div>
<div class="line"><a name="l00159"></a><span class="lineno">  159</span>&#160;    progCount(0),</div>
<div class="line"><a name="l00160"></a><span class="lineno">  160</span>&#160;    use2xSpace(false),</div>
<div class="line"><a name="l00161"></a><span class="lineno">  161</span>&#160;    nItemsPerRun(0),</div>
<div class="line"><a name="l00162"></a><span class="lineno">  162</span>&#160;    nRuns(0),</div>
<div class="line"><a name="l00163"></a><span class="lineno">  163</span>&#160;    mrgArity(0),</div>
<div class="line"><a name="l00164"></a><span class="lineno">  164</span>&#160;    curOutputRunStream(NULL),</div>
<div class="line"><a name="l00165"></a><span class="lineno">  165</span>&#160;    minRunsPerStream(0),</div>
<div class="line"><a name="l00166"></a><span class="lineno">  166</span>&#160;    nXtraRuns(0),</div>
<div class="line"><a name="l00167"></a><span class="lineno">  167</span>&#160;    nItemsInLastRun(0),</div>
<div class="line"><a name="l00168"></a><span class="lineno">  168</span>&#160;    nItemsInThisRun(0),</div>
<div class="line"><a name="l00169"></a><span class="lineno">  169</span>&#160;    runsInStream(0) {</div>
<div class="line"><a name="l00170"></a><span class="lineno">  170</span>&#160;        </div>
<div class="line"><a name="l00171"></a><span class="lineno">  171</span>&#160;    <span class="comment">// Prefix of temp files created during sort</span></div>
<div class="line"><a name="l00172"></a><span class="lineno">  172</span>&#160;    working_disk = std::string(<a class="code" href="classtpie_1_1tempname.html#ad449b140eaf23781a40c26257d8710ab">tempname::tpie_name</a>(<span class="stringliteral">&quot;sort&quot;</span>));</div>
<div class="line"><a name="l00173"></a><span class="lineno">  173</span>&#160;};</div>
<div class="line"><a name="l00174"></a><span class="lineno">  174</span>&#160; </div>
<div class="line"><a name="l00175"></a><span class="lineno">  175</span>&#160;<span class="keyword">template</span>&lt;<span class="keyword">class</span> T, <span class="keyword">class</span> I, <span class="keyword">class</span> M&gt;</div>
<div class="line"><a name="l00176"></a><span class="lineno"><a class="line" href="classtpie_1_1sort__manager.html#ad5cabd9a2f649c29dc7cdf95c39e271b">  176</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="classtpie_1_1sort__manager.html#ad5cabd9a2f649c29dc7cdf95c39e271b">sort_manager&lt;T,I,M&gt;::sort</a>(<a class="code" href="classtpie_1_1file__stream.html">file_stream&lt;T&gt;</a>* in, <a class="code" href="classtpie_1_1file__stream.html">file_stream&lt;T&gt;</a>* out,</div>
<div class="line"><a name="l00177"></a><span class="lineno">  177</span>&#160;                               <a class="code" href="classtpie_1_1progress__indicator__base.html">progress_indicator_base</a>* indicator){</div>
<div class="line"><a name="l00178"></a><span class="lineno">  178</span>&#160;    m_indicator = indicator;</div>
<div class="line"><a name="l00179"></a><span class="lineno">  179</span>&#160; </div>
<div class="line"><a name="l00180"></a><span class="lineno">  180</span>&#160;    <span class="comment">// if the input and output stream are the same, we only use 2x space.</span></div>
<div class="line"><a name="l00181"></a><span class="lineno">  181</span>&#160;    <span class="comment">// otherwise, we need 3x space. (input, current temp runs, output runs)</span></div>
<div class="line"><a name="l00182"></a><span class="lineno">  182</span>&#160;    use2xSpace = (in == out);</div>
<div class="line"><a name="l00183"></a><span class="lineno">  183</span>&#160; </div>
<div class="line"><a name="l00184"></a><span class="lineno">  184</span>&#160;    inStream = in;</div>
<div class="line"><a name="l00185"></a><span class="lineno">  185</span>&#160;    outStream = out;</div>
<div class="line"><a name="l00186"></a><span class="lineno">  186</span>&#160; </div>
<div class="line"><a name="l00187"></a><span class="lineno">  187</span>&#160;    <span class="comment">// Basic checks that input is ok</span></div>
<div class="line"><a name="l00188"></a><span class="lineno">  188</span>&#160;    <span class="keywordflow">if</span> (in==NULL || out==NULL) {</div>
<div class="line"><a name="l00189"></a><span class="lineno">  189</span>&#160;        <span class="keywordflow">if</span> (m_indicator) {m_indicator-&gt;init(1); m_indicator-&gt;step(); m_indicator-&gt;done();}</div>
<div class="line"><a name="l00190"></a><span class="lineno">  190</span>&#160;        <span class="keywordflow">throw</span> <a class="code" href="structtpie_1_1exception.html">exception</a>(<span class="stringliteral">&quot;NULL_POINTER&quot;</span>);</div>
<div class="line"><a name="l00191"></a><span class="lineno">  191</span>&#160;    }</div>
<div class="line"><a name="l00192"></a><span class="lineno">  192</span>&#160; </div>
<div class="line"><a name="l00193"></a><span class="lineno">  193</span>&#160;    <span class="keywordflow">if</span> (inStream-&gt;size() &lt; 2) {</div>
<div class="line"><a name="l00194"></a><span class="lineno">  194</span>&#160;        <span class="keywordflow">if</span> (m_indicator) {m_indicator-&gt;init(1); m_indicator-&gt;step(); m_indicator-&gt;done();}</div>
<div class="line"><a name="l00195"></a><span class="lineno">  195</span>&#160;        in-&gt;seek(0);</div>
<div class="line"><a name="l00196"></a><span class="lineno">  196</span>&#160;        <span class="keywordflow">if</span> (in != out) {</div>
<div class="line"><a name="l00197"></a><span class="lineno">  197</span>&#160;            out-&gt;seek(0);</div>
<div class="line"><a name="l00198"></a><span class="lineno">  198</span>&#160;            <span class="keywordflow">if</span> (in-&gt;size() == 1)</div>
<div class="line"><a name="l00199"></a><span class="lineno">  199</span>&#160;                out-&gt;write(in-&gt;<a class="code" href="classtpie_1_1file__stream.html#af5f0c0a38832561a99d1478377cd1eb9">read</a>());</div>
<div class="line"><a name="l00200"></a><span class="lineno">  200</span>&#160;        }</div>
<div class="line"><a name="l00201"></a><span class="lineno">  201</span>&#160;        <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l00202"></a><span class="lineno">  202</span>&#160;    }</div>
<div class="line"><a name="l00203"></a><span class="lineno">  203</span>&#160;        </div>
<div class="line"><a name="l00204"></a><span class="lineno">  204</span>&#160;    <span class="comment">// Else, there is something to sort, do it</span></div>
<div class="line"><a name="l00205"></a><span class="lineno">  205</span>&#160;    start_sort();</div>
<div class="line"><a name="l00206"></a><span class="lineno">  206</span>&#160;}</div>
<div class="line"><a name="l00207"></a><span class="lineno">  207</span>&#160; </div>
<div class="line"><a name="l00208"></a><span class="lineno">  208</span>&#160;<span class="keyword">template</span>&lt;<span class="keyword">class</span> T, <span class="keyword">class</span> I, <span class="keyword">class</span> M&gt;</div>
<div class="line"><a name="l00209"></a><span class="lineno"><a class="line" href="classtpie_1_1sort__manager.html#aab032fcafa02083ed7aac97d881ae16c">  209</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="classtpie_1_1sort__manager.html#ad5cabd9a2f649c29dc7cdf95c39e271b">sort_manager&lt;T,I,M&gt;::sort</a>(<a class="code" href="classtpie_1_1file__stream.html">file_stream&lt;T&gt;</a>* in, <a class="code" href="classtpie_1_1progress__indicator__base.html">progress_indicator_base</a>* indicator){</div>
<div class="line"><a name="l00210"></a><span class="lineno">  210</span>&#160;    <a class="code" href="namespacetpie.html#af7bd11f9ca8b3252ee4fd9d7f48c05a2">sort</a>(in, in, indicator);</div>
<div class="line"><a name="l00211"></a><span class="lineno">  211</span>&#160;}</div>
<div class="line"><a name="l00212"></a><span class="lineno">  212</span>&#160; </div>
<div class="line"><a name="l00213"></a><span class="lineno">  213</span>&#160;<span class="keyword">template</span>&lt;<span class="keyword">class</span> T, <span class="keyword">class</span> I, <span class="keyword">class</span> M&gt;</div>
<div class="line"><a name="l00214"></a><span class="lineno">  214</span>&#160;<span class="keywordtype">void</span> <a class="code" href="classtpie_1_1sort__manager.html">sort_manager&lt;T,I,M&gt;::start_sort</a>(){</div>
<div class="line"><a name="l00215"></a><span class="lineno">  215</span>&#160;    </div>
<div class="line"><a name="l00216"></a><span class="lineno">  216</span>&#160;    <span class="comment">// ********************************************************************</span></div>
<div class="line"><a name="l00217"></a><span class="lineno">  217</span>&#160;    <span class="comment">// * PHASE 1: See if we can sort the entire stream in internal memory *</span></div>
<div class="line"><a name="l00218"></a><span class="lineno">  218</span>&#160;    <span class="comment">// * without the need to use general merge sort                       *</span></div>
<div class="line"><a name="l00219"></a><span class="lineno">  219</span>&#160;    <span class="comment">// ********************************************************************</span></div>
<div class="line"><a name="l00220"></a><span class="lineno">  220</span>&#160;                </div>
<div class="line"><a name="l00221"></a><span class="lineno">  221</span>&#160;    <span class="comment">// Figure out how much memory we&#39;ve got to work with.</span></div>
<div class="line"><a name="l00222"></a><span class="lineno">  222</span>&#160;    mmBytesAvail = <a class="code" href="namespacetpie.html#ae82b3fc07d981325a56b68663c868a0d">consecutive_memory_available</a>();</div>
<div class="line"><a name="l00223"></a><span class="lineno">  223</span>&#160;        </div>
<div class="line"><a name="l00224"></a><span class="lineno">  224</span>&#160;    <span class="comment">// Space for internal buffers for the input and output stream may not</span></div>
<div class="line"><a name="l00225"></a><span class="lineno">  225</span>&#160;    <span class="comment">// have been allocated yet. Query the space usage and subtract.</span></div>
<div class="line"><a name="l00226"></a><span class="lineno">  226</span>&#160;    mmBytesPerStream = <a class="code" href="classtpie_1_1file__stream.html">file_stream&lt;T&gt;::memory_usage</a>(1);</div>
<div class="line"><a name="l00227"></a><span class="lineno">  227</span>&#160; </div>
<div class="line"><a name="l00228"></a><span class="lineno">  228</span>&#160;    <span class="comment">// This is how much we can use for internal sort if</span></div>
<div class="line"><a name="l00229"></a><span class="lineno">  229</span>&#160;    <span class="comment">// we are not doing general merge sort</span></div>
<div class="line"><a name="l00230"></a><span class="lineno">  230</span>&#160;    mmBytesAvail -= 2 * mmBytesPerStream;</div>
<div class="line"><a name="l00231"></a><span class="lineno">  231</span>&#160;        </div>
<div class="line"><a name="l00232"></a><span class="lineno">  232</span>&#160;    <span class="comment">// Check if all input items can be sorted internally using less than</span></div>
<div class="line"><a name="l00233"></a><span class="lineno">  233</span>&#160;    <span class="comment">// mmBytesAvail</span></div>
<div class="line"><a name="l00234"></a><span class="lineno">  234</span>&#160;    nInputItems = inStream-&gt;size();</div>
<div class="line"><a name="l00235"></a><span class="lineno">  235</span>&#160;    </div>
<div class="line"><a name="l00236"></a><span class="lineno">  236</span>&#160;    inStream-&gt;seek (0);</div>
<div class="line"><a name="l00237"></a><span class="lineno">  237</span>&#160;    </div>
<div class="line"><a name="l00238"></a><span class="lineno">  238</span>&#160;    <span class="keywordflow">if</span> (nInputItems &lt; TPIE_OS_OFFSET(m_internalSorter-&gt;MaxItemCount(mmBytesAvail))) {</div>
<div class="line"><a name="l00239"></a><span class="lineno">  239</span>&#160;        </div>
<div class="line"><a name="l00240"></a><span class="lineno">  240</span>&#160;        <a class="code" href="classtpie_1_1fractional__progress.html">fractional_progress</a> fp(m_indicator);</div>
<div class="line"><a name="l00241"></a><span class="lineno">  241</span>&#160;        fp.id() &lt;&lt; __FILE__ &lt;&lt; __FUNCTION__ &lt;&lt; <span class="stringliteral">&quot;internal_sort&quot;</span> &lt;&lt; <span class="keyword">typeid</span>(T) &lt;&lt; <span class="keyword">typeid</span>(I) &lt;&lt; <span class="keyword">typeid</span>(M);</div>
<div class="line"><a name="l00242"></a><span class="lineno">  242</span>&#160;        <a class="code" href="classtpie_1_1fractional__subindicator.html">fractional_subindicator</a> allocate_progress(fp, <span class="stringliteral">&quot;allocate&quot;</span>, <a class="code" href="fractional__progress_8h.html#a63529a42767e2b1fb6cbc269acbf12f6">TPIE_FSI</a>, nInputItems, <span class="stringliteral">&quot;Allocating&quot;</span>);</div>
<div class="line"><a name="l00243"></a><span class="lineno">  243</span>&#160;        <a class="code" href="classtpie_1_1fractional__subindicator.html">fractional_subindicator</a> sort_progress(fp, <span class="stringliteral">&quot;sort&quot;</span>, <a class="code" href="fractional__progress_8h.html#a63529a42767e2b1fb6cbc269acbf12f6">TPIE_FSI</a>, nInputItems); </div>
<div class="line"><a name="l00244"></a><span class="lineno">  244</span>&#160;        fp.init();</div>
<div class="line"><a name="l00245"></a><span class="lineno">  245</span>&#160;        allocate_progress.init(nInputItems);</div>
<div class="line"><a name="l00246"></a><span class="lineno">  246</span>&#160;        m_internalSorter-&gt;allocate(<span class="keyword">static_cast&lt;</span>TPIE_OS_SIZE_T<span class="keyword">&gt;</span>(nInputItems));</div>
<div class="line"><a name="l00247"></a><span class="lineno">  247</span>&#160;        allocate_progress.done();</div>
<div class="line"><a name="l00248"></a><span class="lineno">  248</span>&#160; </div>
<div class="line"><a name="l00249"></a><span class="lineno">  249</span>&#160;        <span class="comment">// load the items into main memory, sort, and write to output.</span></div>
<div class="line"><a name="l00250"></a><span class="lineno">  250</span>&#160;        <span class="comment">// m_internalSorter also checks if inStream/outStream are the same and</span></div>
<div class="line"><a name="l00251"></a><span class="lineno">  251</span>&#160;        <span class="comment">// truncates/rewrites inStream if they are. This probably should not</span></div>
<div class="line"><a name="l00252"></a><span class="lineno">  252</span>&#160;        <span class="comment">// be the job of m_internalSorter-&gt; TODO: build a cleaner interface</span></div>
<div class="line"><a name="l00253"></a><span class="lineno">  253</span>&#160;        m_internalSorter-&gt;sort(inStream, </div>
<div class="line"><a name="l00254"></a><span class="lineno">  254</span>&#160;                               outStream, </div>
<div class="line"><a name="l00255"></a><span class="lineno">  255</span>&#160;                               <span class="keyword">static_cast&lt;</span>TPIE_OS_SIZE_T<span class="keyword">&gt;</span>(nInputItems), </div>
<div class="line"><a name="l00256"></a><span class="lineno">  256</span>&#160;                               &amp;sort_progress);</div>
<div class="line"><a name="l00257"></a><span class="lineno">  257</span>&#160;        <span class="comment">// de-allocate the internal array of items</span></div>
<div class="line"><a name="l00258"></a><span class="lineno">  258</span>&#160;        m_internalSorter-&gt;deallocate();</div>
<div class="line"><a name="l00259"></a><span class="lineno">  259</span>&#160;        fp.done();</div>
<div class="line"><a name="l00260"></a><span class="lineno">  260</span>&#160;        <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l00261"></a><span class="lineno">  261</span>&#160;    }</div>
<div class="line"><a name="l00262"></a><span class="lineno">  262</span>&#160; </div>
<div class="line"><a name="l00263"></a><span class="lineno">  263</span>&#160;    <span class="comment">// ******************************************************************</span></div>
<div class="line"><a name="l00264"></a><span class="lineno">  264</span>&#160;    <span class="comment">// * Input stream too large for main memory, use general merge sort *</span></div>
<div class="line"><a name="l00265"></a><span class="lineno">  265</span>&#160;    <span class="comment">// ******************************************************************</span></div>
<div class="line"><a name="l00266"></a><span class="lineno">  266</span>&#160;        </div>
<div class="line"><a name="l00267"></a><span class="lineno">  267</span>&#160;    <span class="comment">// PHASE 2: compute nItemsPerRun, nItemsPerRun, nRuns</span></div>
<div class="line"><a name="l00268"></a><span class="lineno">  268</span>&#160;    compute_sort_params();</div>
<div class="line"><a name="l00269"></a><span class="lineno">  269</span>&#160; </div>
<div class="line"><a name="l00270"></a><span class="lineno">  270</span>&#160;    <span class="comment">// ********************************************************************</span></div>
<div class="line"><a name="l00271"></a><span class="lineno">  271</span>&#160;    <span class="comment">// * By this point we have checked that we have valid input, checked  *</span></div>
<div class="line"><a name="l00272"></a><span class="lineno">  272</span>&#160;    <span class="comment">// * that we indeed need an external memory sort, verified that we    *</span></div>
<div class="line"><a name="l00273"></a><span class="lineno">  273</span>&#160;    <span class="comment">// * have enough memory to partition and at least do a binary merge.  *</span></div>
<div class="line"><a name="l00274"></a><span class="lineno">  274</span>&#160;    <span class="comment">// * Also checked that we have enough file descriptors to  merge,     *</span></div>
<div class="line"><a name="l00275"></a><span class="lineno">  275</span>&#160;    <span class="comment">// * and calculated the mrgArity and nItemsPerRun given memory        *</span></div>
<div class="line"><a name="l00276"></a><span class="lineno">  276</span>&#160;    <span class="comment">// * constraints. We have also calculated nRuns for the initial       *</span></div>
<div class="line"><a name="l00277"></a><span class="lineno">  277</span>&#160;    <span class="comment">// * number of runs we will partition into. Let&#39;s sort!               *</span></div>
<div class="line"><a name="l00278"></a><span class="lineno">  278</span>&#160;    <span class="comment">// ********************************************************************</span></div>
<div class="line"><a name="l00279"></a><span class="lineno">  279</span>&#160;        </div>
<div class="line"><a name="l00280"></a><span class="lineno">  280</span>&#160;    <span class="comment">// ********************************************************************</span></div>
<div class="line"><a name="l00281"></a><span class="lineno">  281</span>&#160;    <span class="comment">// * WARNING: Since we accounted for all known memory usage in PHASE 2*</span></div>
<div class="line"><a name="l00282"></a><span class="lineno">  282</span>&#160;    <span class="comment">// * be very wary of memory allocation via &quot;new&quot; or constructors from *</span></div>
<div class="line"><a name="l00283"></a><span class="lineno">  283</span>&#160;    <span class="comment">// * this point on and make sure it was accounted for in PHASE 2      *</span></div>
<div class="line"><a name="l00284"></a><span class="lineno">  284</span>&#160;    <span class="comment">// ********************************************************************</span></div>
<div class="line"><a name="l00285"></a><span class="lineno">  285</span>&#160;    fractional_progress fp(m_indicator);</div>
<div class="line"><a name="l00286"></a><span class="lineno">  286</span>&#160;    fp.id() &lt;&lt; __FILE__ &lt;&lt; __FUNCTION__ &lt;&lt; <span class="stringliteral">&quot;external_sort&quot;</span> &lt;&lt; <span class="keyword">typeid</span>(T) &lt;&lt; <span class="keyword">typeid</span>(I) &lt;&lt; <span class="keyword">typeid</span>(M);</div>
<div class="line"><a name="l00287"></a><span class="lineno">  287</span>&#160;    fractional_subindicator run_progress(fp, <span class="stringliteral">&quot;run&quot;</span>, <a class="code" href="fractional__progress_8h.html#a63529a42767e2b1fb6cbc269acbf12f6">TPIE_FSI</a>, nInputItems,<span class="stringliteral">&quot;&quot;</span>,tpie::IMPORTANCE_LOG);</div>
<div class="line"><a name="l00288"></a><span class="lineno">  288</span>&#160;    fractional_subindicator merge_progress(fp, <span class="stringliteral">&quot;merge&quot;</span>, <a class="code" href="fractional__progress_8h.html#a63529a42767e2b1fb6cbc269acbf12f6">TPIE_FSI</a>, nInputItems,<span class="stringliteral">&quot;&quot;</span>,tpie::IMPORTANCE_LOG);</div>
<div class="line"><a name="l00289"></a><span class="lineno">  289</span>&#160;    fp.init();</div>
<div class="line"><a name="l00290"></a><span class="lineno">  290</span>&#160; </div>
<div class="line"><a name="l00291"></a><span class="lineno">  291</span>&#160;    <a class="code" href="classtpie_1_1array.html">tpie::array&lt;temp_file&gt;</a> temporaries(mrgArity*2);</div>
<div class="line"><a name="l00292"></a><span class="lineno">  292</span>&#160; </div>
<div class="line"><a name="l00293"></a><span class="lineno">  293</span>&#160;    <span class="comment">// PHASE 3: partition and form sorted runs</span></div>
<div class="line"><a name="l00294"></a><span class="lineno">  294</span>&#160;    TP_LOG_DEBUG_ID (<span class="stringliteral">&quot;Beginning general merge sort.&quot;</span>);</div>
<div class="line"><a name="l00295"></a><span class="lineno">  295</span>&#160;    partition_and_sort_runs(&amp;run_progress, temporaries);</div>
<div class="line"><a name="l00296"></a><span class="lineno">  296</span>&#160;    <span class="comment">// PHASE 4: merge sorted runs to a single output stream</span></div>
<div class="line"><a name="l00297"></a><span class="lineno">  297</span>&#160;    merge_to_output(&amp;merge_progress, temporaries);</div>
<div class="line"><a name="l00298"></a><span class="lineno">  298</span>&#160;    </div>
<div class="line"><a name="l00299"></a><span class="lineno">  299</span>&#160;    fp.done();</div>
<div class="line"><a name="l00300"></a><span class="lineno">  300</span>&#160;}</div>
<div class="line"><a name="l00301"></a><span class="lineno">  301</span>&#160; </div>
<div class="line"><a name="l00302"></a><span class="lineno">  302</span>&#160;<span class="keyword">template</span>&lt;<span class="keyword">class</span> T, <span class="keyword">class</span> I, <span class="keyword">class</span> M&gt;</div>
<div class="line"><a name="l00303"></a><span class="lineno">  303</span>&#160;<span class="keywordtype">void</span> sort_manager&lt;T,I,M&gt;::compute_sort_params(<span class="keywordtype">void</span>){</div>
<div class="line"><a name="l00304"></a><span class="lineno">  304</span>&#160;    <span class="comment">// ********************************************************************</span></div>
<div class="line"><a name="l00305"></a><span class="lineno">  305</span>&#160;    <span class="comment">// * PHASE 2: Compute/check limits                                    *</span></div>
<div class="line"><a name="l00306"></a><span class="lineno">  306</span>&#160;    <span class="comment">// * Compute the maximum number of items we can sort in main memory   *</span></div>
<div class="line"><a name="l00307"></a><span class="lineno">  307</span>&#160;    <span class="comment">// * and the maximium number of sorted runs we can merge at one time  *</span></div>
<div class="line"><a name="l00308"></a><span class="lineno">  308</span>&#160;    <span class="comment">// * Before doing any sorting, check that we can fit at least one item*</span></div>
<div class="line"><a name="l00309"></a><span class="lineno">  309</span>&#160;    <span class="comment">// * in internal memory for sorting and that we can merge at least two*</span></div>
<div class="line"><a name="l00310"></a><span class="lineno">  310</span>&#160;    <span class="comment">// * runs at at time                                                  *</span></div>
<div class="line"><a name="l00311"></a><span class="lineno">  311</span>&#160;    <span class="comment">// *                                                                  *</span></div>
<div class="line"><a name="l00312"></a><span class="lineno">  312</span>&#160;    <span class="comment">// * Memory needed for the run formation phase:                       *</span></div>
<div class="line"><a name="l00313"></a><span class="lineno">  313</span>&#160;    <span class="comment">// * 2*mmBytesPerStream +                  {for input/output streams} *</span></div>
<div class="line"><a name="l00314"></a><span class="lineno">  314</span>&#160;    <span class="comment">// * nItemsPerRun*space_per_sort_item() +  {for each item sorted }    *</span></div>
<div class="line"><a name="l00315"></a><span class="lineno">  315</span>&#160;    <span class="comment">// * space_overhead_sort()                 {constant overhead in      *</span></div>
<div class="line"><a name="l00316"></a><span class="lineno">  316</span>&#160;    <span class="comment">// *                                        sort management object    *</span></div>
<div class="line"><a name="l00317"></a><span class="lineno">  317</span>&#160;    <span class="comment">// *                                        during sorting       }    *</span></div>
<div class="line"><a name="l00318"></a><span class="lineno">  318</span>&#160;    <span class="comment">// *                                                                  *</span></div>
<div class="line"><a name="l00319"></a><span class="lineno">  319</span>&#160;    <span class="comment">// * Memory needed for a D-way merge:                                 *</span></div>
<div class="line"><a name="l00320"></a><span class="lineno">  320</span>&#160;    <span class="comment">// *  Cost per merge stream:                                          *</span></div>
<div class="line"><a name="l00321"></a><span class="lineno">  321</span>&#160;    <span class="comment">// *   mmBytesPerStream+              {a open stream to read from}    *</span></div>
<div class="line"><a name="l00322"></a><span class="lineno">  322</span>&#160;    <span class="comment">// *   space_per_merge_item()+        {used in internal merge heap}   *</span></div>
<div class="line"><a name="l00323"></a><span class="lineno">  323</span>&#160;    <span class="comment">// *   sizeof(T*)+sizeof(off_t)       {arrays in single_merge()}      *</span></div>
<div class="line"><a name="l00324"></a><span class="lineno">  324</span>&#160;    <span class="comment">// *   sizeof(stream&lt;T&gt;*)         {array element that points to   *</span></div>
<div class="line"><a name="l00325"></a><span class="lineno">  325</span>&#160;    <span class="comment">// *                                    merge stream}                 *</span></div>
<div class="line"><a name="l00326"></a><span class="lineno">  326</span>&#160;    <span class="comment">// *  Fixed costs:                                                    *</span></div>
<div class="line"><a name="l00327"></a><span class="lineno">  327</span>&#160;    <span class="comment">// *    2*mmBytesPerStream+        {original input stream + output    *</span></div>
<div class="line"><a name="l00328"></a><span class="lineno">  328</span>&#160;    <span class="comment">// *                                 of current merge}                *</span></div>
<div class="line"><a name="l00329"></a><span class="lineno">  329</span>&#160;    <span class="comment">// *    space_overhead_merge()+    {fixed dynamic memory costs of     *</span></div>
<div class="line"><a name="l00330"></a><span class="lineno">  330</span>&#160;    <span class="comment">// *                                 merge heap}                      *</span></div>
<div class="line"><a name="l00331"></a><span class="lineno">  331</span>&#160;    <span class="comment">// *    3*space_overhead()         {overhead per &quot;new&quot; memory request *</span></div>
<div class="line"><a name="l00332"></a><span class="lineno">  332</span>&#160;    <span class="comment">// *                                for allocating array of streams   *</span></div>
<div class="line"><a name="l00333"></a><span class="lineno">  333</span>&#160;    <span class="comment">// *                                in merge_to_output and two arrays *</span></div>
<div class="line"><a name="l00334"></a><span class="lineno">  334</span>&#160;    <span class="comment">// *                                in single_merge}                  *</span></div>
<div class="line"><a name="l00335"></a><span class="lineno">  335</span>&#160;    <span class="comment">// *                                                                  *</span></div>
<div class="line"><a name="l00336"></a><span class="lineno">  336</span>&#160;    <span class="comment">// *  Total cost for D-way Merge:                                     *</span></div>
<div class="line"><a name="l00337"></a><span class="lineno">  337</span>&#160;    <span class="comment">// *    D*(Cost per merge stream)+(Fixed costs)                       *</span></div>
<div class="line"><a name="l00338"></a><span class="lineno">  338</span>&#160;    <span class="comment">// *                                                                  *</span></div>
<div class="line"><a name="l00339"></a><span class="lineno">  339</span>&#160;    <span class="comment">// *  Any additional memory requests that call &quot;new&quot; directly or      *</span></div>
<div class="line"><a name="l00340"></a><span class="lineno">  340</span>&#160;    <span class="comment">// *  indirectly should be documented and accounted for in this phase *</span></div>
<div class="line"><a name="l00341"></a><span class="lineno">  341</span>&#160;    <span class="comment">// ********************************************************************</span></div>
<div class="line"><a name="l00342"></a><span class="lineno">  342</span>&#160;        </div>
<div class="line"><a name="l00343"></a><span class="lineno">  343</span>&#160;    TP_LOG_DEBUG_ID (<span class="stringliteral">&quot;Computing merge sort parameters.&quot;</span>);</div>
<div class="line"><a name="l00344"></a><span class="lineno">  344</span>&#160;        </div>
<div class="line"><a name="l00345"></a><span class="lineno">  345</span>&#160;    TPIE_OS_SIZE_T mmBytesAvailSort; <span class="comment">// Bytes available for sorting</span></div>
<div class="line"><a name="l00346"></a><span class="lineno">  346</span>&#160;        </div>
<div class="line"><a name="l00347"></a><span class="lineno">  347</span>&#160;    TP_LOG_DEBUG (<span class="stringliteral">&quot;Each object of size &quot;</span> &lt;&lt; <span class="keyword">static_cast&lt;</span>TPIE_OS_OUTPUT_SIZE_T<span class="keyword">&gt;</span>(<span class="keyword">sizeof</span>(T)) &lt;&lt; <span class="stringliteral">&quot; uses &quot;</span></div>
<div class="line"><a name="l00348"></a><span class="lineno">  348</span>&#160;                  &lt;&lt; <span class="keyword">static_cast&lt;</span>TPIE_OS_OUTPUT_SIZE_T<span class="keyword">&gt;</span>(m_internalSorter-&gt;space_per_item ()) &lt;&lt; <span class="stringliteral">&quot; bytes &quot;</span></div>
<div class="line"><a name="l00349"></a><span class="lineno">  349</span>&#160;                  &lt;&lt; <span class="stringliteral">&quot;for sorting in memory\n&quot;</span>);</div>
<div class="line"><a name="l00350"></a><span class="lineno">  350</span>&#160;        </div>
<div class="line"><a name="l00351"></a><span class="lineno">  351</span>&#160;    <span class="comment">// Subtract off size of temp output stream</span></div>
<div class="line"><a name="l00352"></a><span class="lineno">  352</span>&#160;    <span class="comment">// The size of the input stream was already subtracted from</span></div>
<div class="line"><a name="l00353"></a><span class="lineno">  353</span>&#160;    <span class="comment">// mmBytesAvail</span></div>
<div class="line"><a name="l00354"></a><span class="lineno">  354</span>&#160;    mmBytesAvailSort=mmBytesAvail - mmBytesPerStream;</div>
<div class="line"><a name="l00355"></a><span class="lineno">  355</span>&#160;        </div>
<div class="line"><a name="l00356"></a><span class="lineno">  356</span>&#160;    nItemsPerRun=m_internalSorter-&gt;MaxItemCount(mmBytesAvailSort);</div>
<div class="line"><a name="l00357"></a><span class="lineno">  357</span>&#160;        </div>
<div class="line"><a name="l00358"></a><span class="lineno">  358</span>&#160;    <span class="keywordflow">if</span>(nItemsPerRun&lt;1){</div>
<div class="line"><a name="l00359"></a><span class="lineno">  359</span>&#160;        <span class="keywordflow">throw</span> stream_exception(<span class="stringliteral">&quot;Insufficient Memory for forming sorted runs&quot;</span>);</div>
<div class="line"><a name="l00360"></a><span class="lineno">  360</span>&#160;    }</div>
<div class="line"><a name="l00361"></a><span class="lineno">  361</span>&#160; </div>
<div class="line"><a name="l00362"></a><span class="lineno">  362</span>&#160;    <span class="comment">// Now we know the max number of Items we can sort in a single</span></div>
<div class="line"><a name="l00363"></a><span class="lineno">  363</span>&#160;    <span class="comment">// internal memory run. Next, compute the number of runs we can</span></div>
<div class="line"><a name="l00364"></a><span class="lineno">  364</span>&#160;    <span class="comment">// merge together at one time</span></div>
<div class="line"><a name="l00365"></a><span class="lineno">  365</span>&#160;        </div>
<div class="line"><a name="l00366"></a><span class="lineno">  366</span>&#160;    TPIE_OS_SIZE_T mmBytesPerMergeItem = mmBytesPerStream +</div>
<div class="line"><a name="l00367"></a><span class="lineno">  367</span>&#160;        m_mergeHeap-&gt;space_per_item() + <span class="keyword">sizeof</span>(T*) +</div>
<div class="line"><a name="l00368"></a><span class="lineno">  368</span>&#160;        <span class="keyword">sizeof</span>(TPIE_OS_OFFSET)+<span class="keyword">sizeof</span>(ami::stream&lt;T&gt;*);</div>
<div class="line"><a name="l00369"></a><span class="lineno">  369</span>&#160;        </div>
<div class="line"><a name="l00370"></a><span class="lineno">  370</span>&#160;    <span class="comment">// Fixed cost of mergheap impl. + MM_manager overhead of allocating</span></div>
<div class="line"><a name="l00371"></a><span class="lineno">  371</span>&#160;    <span class="comment">// an array of stream&lt;T&gt; ptrs (pending)</span></div>
<div class="line"><a name="l00372"></a><span class="lineno">  372</span>&#160;    <span class="comment">// cost of Input stream already accounted for in mmBytesAvail..</span></div>
<div class="line"><a name="l00373"></a><span class="lineno">  373</span>&#160;    TPIE_OS_SIZE_T mmBytesFixedForMerge = m_mergeHeap-&gt;space_overhead() +</div>
<div class="line"><a name="l00374"></a><span class="lineno">  374</span>&#160;        mmBytesPerStream;</div>
<div class="line"><a name="l00375"></a><span class="lineno">  375</span>&#160; </div>
<div class="line"><a name="l00376"></a><span class="lineno">  376</span>&#160;    <span class="keywordflow">if</span> (mmBytesFixedForMerge &gt; mmBytesAvail) {</div>
<div class="line"><a name="l00377"></a><span class="lineno">  377</span>&#160;        <span class="keywordflow">throw</span> stream_exception(<span class="stringliteral">&quot;Insufficient memory for merge heap and output stream&quot;</span>);</div>
<div class="line"><a name="l00378"></a><span class="lineno">  378</span>&#160;    }</div>
<div class="line"><a name="l00379"></a><span class="lineno">  379</span>&#160;        </div>
<div class="line"><a name="l00380"></a><span class="lineno">  380</span>&#160;    <span class="comment">// Cast down from TPIE_OS_OFFSET (type of mmBytesAvail).</span></div>
<div class="line"><a name="l00381"></a><span class="lineno">  381</span>&#160;    <span class="comment">// mmBytesPerMergeItem is at least 1KB, so we are OK unless we</span></div>
<div class="line"><a name="l00382"></a><span class="lineno">  382</span>&#160;    <span class="comment">// have more than 2 TerraBytes of memory, assuming 64 bit</span></div>
<div class="line"><a name="l00383"></a><span class="lineno">  383</span>&#160;    <span class="comment">// (or smaller) TPIE_OS_OFFSETS. I look forward to the day</span></div>
<div class="line"><a name="l00384"></a><span class="lineno">  384</span>&#160;    <span class="comment">// this comment seems silly and wrong</span></div>
<div class="line"><a name="l00385"></a><span class="lineno">  385</span>&#160;    mrgArity = <span class="keyword">static_cast&lt;</span><a class="code" href="namespacetpie.html#a90b015a1fcd16bdca3002ce6f6fe89eb">arity_t</a><span class="keyword">&gt;</span>(mmBytesAvail-mmBytesFixedForMerge) /</div>
<div class="line"><a name="l00386"></a><span class="lineno">  386</span>&#160;        mmBytesPerMergeItem;</div>
<div class="line"><a name="l00387"></a><span class="lineno">  387</span>&#160;    TP_LOG_DEBUG(<span class="stringliteral">&quot;mem avail=&quot;</span> &lt;&lt; <span class="keyword">static_cast&lt;</span>TPIE_OS_OUTPUT_SIZE_T<span class="keyword">&gt;</span>(mmBytesAvail-mmBytesFixedForMerge)</div>
<div class="line"><a name="l00388"></a><span class="lineno">  388</span>&#160;                 &lt;&lt; <span class="stringliteral">&quot; bytes per merge item=&quot;</span> &lt;&lt;  <span class="keyword">static_cast&lt;</span>TPIE_OS_OUTPUT_SIZE_T<span class="keyword">&gt;</span>(mmBytesPerMergeItem)</div>
<div class="line"><a name="l00389"></a><span class="lineno">  389</span>&#160;                 &lt;&lt; <span class="stringliteral">&quot; initial mrgArity=&quot;</span> &lt;&lt; <span class="keyword">static_cast&lt;</span>TPIE_OS_OUTPUT_SIZE_T<span class="keyword">&gt;</span>(mrgArity) &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>);</div>
<div class="line"><a name="l00390"></a><span class="lineno">  390</span>&#160;        </div>
<div class="line"><a name="l00391"></a><span class="lineno">  391</span>&#160;    <span class="comment">// Need to support at least binary merge</span></div>
<div class="line"><a name="l00392"></a><span class="lineno">  392</span>&#160;    <span class="keywordflow">if</span>(mrgArity &lt; 2) {</div>
<div class="line"><a name="l00393"></a><span class="lineno">  393</span>&#160;        <span class="keywordflow">throw</span> stream_exception(<span class="stringliteral">&quot;Merge arity &lt; 2 -- Insufficient memory for a merge.&quot;</span>);</div>
<div class="line"><a name="l00394"></a><span class="lineno">  394</span>&#160;    }</div>
<div class="line"><a name="l00395"></a><span class="lineno">  395</span>&#160; </div>
<div class="line"><a name="l00396"></a><span class="lineno">  396</span>&#160;    <span class="comment">// Make sure that the AMI is willing to provide us with the</span></div>
<div class="line"><a name="l00397"></a><span class="lineno">  397</span>&#160;    <span class="comment">// number of substreams we want.  It may not be able to due to</span></div>
<div class="line"><a name="l00398"></a><span class="lineno">  398</span>&#160;    <span class="comment">// operating system restrictions, such as on the number of regions</span></div>
<div class="line"><a name="l00399"></a><span class="lineno">  399</span>&#160;    <span class="comment">// that can be mmap()ed in, max number of file descriptors, etc.</span></div>
<div class="line"><a name="l00400"></a><span class="lineno">  400</span>&#160;    <span class="keywordtype">int</span> availableStreams = <span class="keyword">static_cast&lt;</span><span class="keywordtype">int</span><span class="keyword">&gt;</span>(<a class="code" href="namespacetpie.html#aee9b06be9e89dab272a40aae7f5d81c6">get_file_manager</a>().<a class="code" href="classtpie_1_1resource__manager.html#a9fc95070beb5c44f757b6f31fea80d2b">available</a>());</div>
<div class="line"><a name="l00401"></a><span class="lineno">  401</span>&#160;        </div>
<div class="line"><a name="l00402"></a><span class="lineno">  402</span>&#160;    <span class="comment">// Merging requires an available stream/file decriptor for</span></div>
<div class="line"><a name="l00403"></a><span class="lineno">  403</span>&#160;    <span class="comment">// each of the mrgArity input strems. We need one additional file descriptor</span></div>
<div class="line"><a name="l00404"></a><span class="lineno">  404</span>&#160;    <span class="comment">// for the output of the current merge, so binary merge requires</span></div>
<div class="line"><a name="l00405"></a><span class="lineno">  405</span>&#160;    <span class="comment">// three available streams.</span></div>
<div class="line"><a name="l00406"></a><span class="lineno">  406</span>&#160;    <span class="keywordflow">if</span> (availableStreams &lt; 3) {</div>
<div class="line"><a name="l00407"></a><span class="lineno">  407</span>&#160;        <span class="keywordflow">throw</span> stream_exception(<span class="stringliteral">&quot;Not enough stream descriptors available to perform merge.&quot;</span>);</div>
<div class="line"><a name="l00408"></a><span class="lineno">  408</span>&#160;    }</div>
<div class="line"><a name="l00409"></a><span class="lineno">  409</span>&#160;        </div>
<div class="line"><a name="l00410"></a><span class="lineno">  410</span>&#160;    <span class="comment">// Can at least do binary merge. See if availableStreams limits</span></div>
<div class="line"><a name="l00411"></a><span class="lineno">  411</span>&#160;    <span class="comment">// maximum mrgArity</span></div>
<div class="line"><a name="l00412"></a><span class="lineno">  412</span>&#160;    <span class="comment">// Due to the previous test, we know that available_streams &gt;= 3.</span></div>
<div class="line"><a name="l00413"></a><span class="lineno">  413</span>&#160;    <span class="keywordflow">if</span> (mrgArity &gt; <span class="keyword">static_cast&lt;</span><a class="code" href="namespacetpie.html#a90b015a1fcd16bdca3002ce6f6fe89eb">arity_t</a><span class="keyword">&gt;</span>(availableStreams - 1)) {</div>
<div class="line"><a name="l00414"></a><span class="lineno">  414</span>&#160; </div>
<div class="line"><a name="l00415"></a><span class="lineno">  415</span>&#160;        mrgArity = <span class="keyword">static_cast&lt;</span><a class="code" href="namespacetpie.html#a90b015a1fcd16bdca3002ce6f6fe89eb">arity_t</a><span class="keyword">&gt;</span>(availableStreams - 1);</div>
<div class="line"><a name="l00416"></a><span class="lineno">  416</span>&#160;        </div>
<div class="line"><a name="l00417"></a><span class="lineno">  417</span>&#160;        TP_LOG_DEBUG_ID (<span class="stringliteral">&quot;Reduced merge arity due to AMI restrictions.&quot;</span>);</div>
<div class="line"><a name="l00418"></a><span class="lineno">  418</span>&#160;    }</div>
<div class="line"><a name="l00419"></a><span class="lineno">  419</span>&#160;        </div>
<div class="line"><a name="l00420"></a><span class="lineno">  420</span>&#160;    <span class="comment">// The number of memory-sized runs that the original input stream</span></div>
<div class="line"><a name="l00421"></a><span class="lineno">  421</span>&#160;    <span class="comment">// will be partitioned into.</span></div>
<div class="line"><a name="l00422"></a><span class="lineno">  422</span>&#160;    nRuns = ((nInputItems + nItemsPerRun - 1) / nItemsPerRun);</div>
<div class="line"><a name="l00423"></a><span class="lineno">  423</span>&#160;        </div>
<div class="line"><a name="l00424"></a><span class="lineno">  424</span>&#160;<span class="preprocessor">#ifdef TPIE_SORT_SMALL_MRGARITY</span></div>
<div class="line"><a name="l00425"></a><span class="lineno">  425</span>&#160;    <span class="comment">// KEEP OUT!!!</span></div>
<div class="line"><a name="l00426"></a><span class="lineno">  426</span>&#160;    <span class="comment">// This should not be done by the typical user and is only for</span></div>
<div class="line"><a name="l00427"></a><span class="lineno">  427</span>&#160;    <span class="comment">// testing/debugging purposes. ONLY define this flag and set a value</span></div>
<div class="line"><a name="l00428"></a><span class="lineno">  428</span>&#160;    <span class="comment">// if you know what you are doing.</span></div>
<div class="line"><a name="l00429"></a><span class="lineno">  429</span>&#160;    TP_LOG_WARNING_ID(<span class="stringliteral">&quot;TPIE_SORT_SMALL_MRGARITY flag is set.&quot;</span></div>
<div class="line"><a name="l00430"></a><span class="lineno">  430</span>&#160;                      <span class="stringliteral">&quot; Did you mean to do this?&quot;</span>);</div>
<div class="line"><a name="l00431"></a><span class="lineno">  431</span>&#160;    <span class="keywordflow">if</span>(mrgArity &gt; TPIE_SORT_SMALL_MRGARITY) {</div>
<div class="line"><a name="l00432"></a><span class="lineno">  432</span>&#160;        TP_LOG_WARNING_ID(<span class="stringliteral">&quot;Reducing merge arity due to compiler specified flag&quot;</span>);</div>
<div class="line"><a name="l00433"></a><span class="lineno">  433</span>&#160;        mrgArity=TPIE_SORT_SMALL_MRGARITY;</div>
<div class="line"><a name="l00434"></a><span class="lineno">  434</span>&#160;    }</div>
<div class="line"><a name="l00435"></a><span class="lineno">  435</span>&#160;<span class="preprocessor">#endif // TPIE_SORT_SMALL_MRGARITY</span></div>
<div class="line"><a name="l00436"></a><span class="lineno">  436</span>&#160; </div>
<div class="line"><a name="l00437"></a><span class="lineno">  437</span>&#160;<span class="preprocessor">#ifdef TPIE_SORT_SMALL_RUNSIZE</span></div>
<div class="line"><a name="l00438"></a><span class="lineno">  438</span>&#160;    <span class="comment">// KEEP OUT!!!</span></div>
<div class="line"><a name="l00439"></a><span class="lineno">  439</span>&#160;    <span class="comment">// This should not be done by the typical user and is only for</span></div>
<div class="line"><a name="l00440"></a><span class="lineno">  440</span>&#160;    <span class="comment">// testing/debugging purposes ONLY define this flag and set a value</span></div>
<div class="line"><a name="l00441"></a><span class="lineno">  441</span>&#160;    <span class="comment">// if you know what you are doing.</span></div>
<div class="line"><a name="l00442"></a><span class="lineno">  442</span>&#160;    TP_LOG_WARNING_ID(<span class="stringliteral">&quot;TPIE_SORT_SMALL_RUNSIZE flag is set.&quot;</span></div>
<div class="line"><a name="l00443"></a><span class="lineno">  443</span>&#160;                      <span class="stringliteral">&quot; Did you mean to do this?&quot;</span>);</div>
<div class="line"><a name="l00444"></a><span class="lineno">  444</span>&#160;    <span class="keywordflow">if</span>(nItemsPerRun &gt; TPIE_SORT_SMALL_RUNSIZE) {</div>
<div class="line"><a name="l00445"></a><span class="lineno">  445</span>&#160;        TP_LOG_WARNING_ID(<span class="stringliteral">&quot;Reducing run size due to compiler specified flag&quot;</span>);</div>
<div class="line"><a name="l00446"></a><span class="lineno">  446</span>&#160;        nItemsPerRun=TPIE_SORT_SMALL_RUNSIZE;</div>
<div class="line"><a name="l00447"></a><span class="lineno">  447</span>&#160;    }</div>
<div class="line"><a name="l00448"></a><span class="lineno">  448</span>&#160; </div>
<div class="line"><a name="l00449"></a><span class="lineno">  449</span>&#160;    <span class="comment">// need to adjust nRuns</span></div>
<div class="line"><a name="l00450"></a><span class="lineno">  450</span>&#160;    nRuns = ((nInputItems + nItemsPerRun - 1) / nItemsPerRun);</div>
<div class="line"><a name="l00451"></a><span class="lineno">  451</span>&#160;<span class="preprocessor">#endif // TPIE_SORT_SMALL_RUNSIZE</span></div>
<div class="line"><a name="l00452"></a><span class="lineno">  452</span>&#160; </div>
<div class="line"><a name="l00453"></a><span class="lineno">  453</span>&#160;    <span class="comment">//#define MINIMIZE_INITIAL_RUN_LENGTH</span></div>
<div class="line"><a name="l00454"></a><span class="lineno">  454</span>&#160;<span class="preprocessor">#ifdef MINIMIZE_INITIAL_RUN_LENGTH</span></div>
<div class="line"><a name="l00455"></a><span class="lineno">  455</span>&#160;    <span class="comment">// If compiled with the above flag, try to reduce the length of</span></div>
<div class="line"><a name="l00456"></a><span class="lineno">  456</span>&#160;    <span class="comment">// the initial sorted runs without increasing the merge tree height</span></div>
<div class="line"><a name="l00457"></a><span class="lineno">  457</span>&#160;    <span class="comment">// This could be a speed-up if it is faster to quicksort many small</span></div>
<div class="line"><a name="l00458"></a><span class="lineno">  458</span>&#160;    <span class="comment">// runs and merge them than it is to quicksort fewer long </span></div>
<div class="line"><a name="l00459"></a><span class="lineno">  459</span>&#160;    <span class="comment">// runs and merge them.</span></div>
<div class="line"><a name="l00460"></a><span class="lineno">  460</span>&#160;    TP_LOG_DEBUG_ID (<span class="stringliteral">&quot;Minimizing initial run lengths without increasing&quot;</span> &lt;&lt;</div>
<div class="line"><a name="l00461"></a><span class="lineno">  461</span>&#160;                     <span class="stringliteral">&quot; the height of the merge tree.&quot;</span>);</div>
<div class="line"><a name="l00462"></a><span class="lineno">  462</span>&#160; </div>
<div class="line"><a name="l00463"></a><span class="lineno">  463</span>&#160;    <span class="comment">// The tree height is the ceiling of the log base mrgArity of the</span></div>
<div class="line"><a name="l00464"></a><span class="lineno">  464</span>&#160;    <span class="comment">// number of original runs.</span></div>
<div class="line"><a name="l00465"></a><span class="lineno">  465</span>&#160;    <span class="keywordtype">double</span> tree_height = log((<span class="keywordtype">double</span>)nRuns) / log((<span class="keywordtype">double</span>)mrgArity);</div>
<div class="line"><a name="l00466"></a><span class="lineno">  466</span>&#160;    <a class="code" href="tpie__assert_8h.html#aa94b0c564b3fcb1afbe20c17fbaf95fd">tp_assert</a> (tree_height &gt; 0, <span class="stringliteral">&quot;Negative or zero tree height!&quot;</span>);</div>
<div class="line"><a name="l00467"></a><span class="lineno">  467</span>&#160;    tree_height = ceil (tree_height);</div>
<div class="line"><a name="l00468"></a><span class="lineno">  468</span>&#160; </div>
<div class="line"><a name="l00469"></a><span class="lineno">  469</span>&#160;    <span class="comment">// See how many runs we could possibly fit in the tree without</span></div>
<div class="line"><a name="l00470"></a><span class="lineno">  470</span>&#160;    <span class="comment">// increasing the height.</span></div>
<div class="line"><a name="l00471"></a><span class="lineno">  471</span>&#160;    <span class="keywordtype">double</span> maxOrigRuns = pow ((<span class="keywordtype">double</span>) mrgArity, tree_height);</div>
<div class="line"><a name="l00472"></a><span class="lineno">  472</span>&#160;    <a class="code" href="tpie__assert_8h.html#aa94b0c564b3fcb1afbe20c17fbaf95fd">tp_assert</a> (maxOrigRuns &gt;= nRuns <span class="stringliteral">&quot;Number of permitted runs was reduced!&quot;</span>);</div>
<div class="line"><a name="l00473"></a><span class="lineno">  473</span>&#160; </div>
<div class="line"><a name="l00474"></a><span class="lineno">  474</span>&#160;    <span class="comment">// How big will such runs be?</span></div>
<div class="line"><a name="l00475"></a><span class="lineno">  475</span>&#160;    <span class="keywordtype">double</span> new_nItemsPerRun = ceil (nInputItems/ maxOrigRuns);</div>
<div class="line"><a name="l00476"></a><span class="lineno">  476</span>&#160;    <a class="code" href="tpie__assert_8h.html#aa94b0c564b3fcb1afbe20c17fbaf95fd">tp_assert</a> (new_nItemsPerRun &lt;= nItemsPerRun, </div>
<div class="line"><a name="l00477"></a><span class="lineno">  477</span>&#160;               <span class="stringliteral">&quot;Size of original runs increased!&quot;</span>);</div>
<div class="line"><a name="l00478"></a><span class="lineno">  478</span>&#160; </div>
<div class="line"><a name="l00479"></a><span class="lineno">  479</span>&#160;    <span class="comment">// Update the number of items per run and the number of original runs</span></div>
<div class="line"><a name="l00480"></a><span class="lineno">  480</span>&#160;    nItemsPerRun = (TPIE_OS_SIZE_T) new_nItemsPerRun;</div>
<div class="line"><a name="l00481"></a><span class="lineno">  481</span>&#160; </div>
<div class="line"><a name="l00482"></a><span class="lineno">  482</span>&#160;    TP_LOG_DEBUG_ID (<span class="stringliteral">&quot;With long internal memory runs, nRuns = &quot;</span></div>
<div class="line"><a name="l00483"></a><span class="lineno">  483</span>&#160;                     &lt;&lt; nRuns);</div>
<div class="line"><a name="l00484"></a><span class="lineno">  484</span>&#160; </div>
<div class="line"><a name="l00485"></a><span class="lineno">  485</span>&#160;    nRuns = (nInputItems + nItemsPerRun - 1) / nItemsPerRun;</div>
<div class="line"><a name="l00486"></a><span class="lineno">  486</span>&#160; </div>
<div class="line"><a name="l00487"></a><span class="lineno">  487</span>&#160;    TP_LOG_DEBUG_ID (<span class="stringliteral">&quot;With shorter internal memory runs &quot;</span></div>
<div class="line"><a name="l00488"></a><span class="lineno">  488</span>&#160;                     &lt;&lt; <span class="stringliteral">&quot;and the same merge tree height, nRuns = &quot;</span></div>
<div class="line"><a name="l00489"></a><span class="lineno">  489</span>&#160;                     &lt;&lt; nRuns );</div>
<div class="line"><a name="l00490"></a><span class="lineno">  490</span>&#160; </div>
<div class="line"><a name="l00491"></a><span class="lineno">  491</span>&#160;    <a class="code" href="tpie__assert_8h.html#aa94b0c564b3fcb1afbe20c17fbaf95fd">tp_assert</a> (maxOrigRuns &gt;= nRuns,</div>
<div class="line"><a name="l00492"></a><span class="lineno">  492</span>&#160;               <span class="stringliteral">&quot;We increased the merge height when we weren&#39;t supposed to do so!&quot;</span>);</div>
<div class="line"><a name="l00493"></a><span class="lineno">  493</span>&#160;<span class="preprocessor">#endif  // MINIMIZE_INITIAL_SUBSTREAM_LENGTH</span></div>
<div class="line"><a name="l00494"></a><span class="lineno">  494</span>&#160; </div>
<div class="line"><a name="l00495"></a><span class="lineno">  495</span>&#160; </div>
<div class="line"><a name="l00496"></a><span class="lineno">  496</span>&#160;        <span class="comment">// If we have just a few runs, we don&#39;t need the</span></div>
<div class="line"><a name="l00497"></a><span class="lineno">  497</span>&#160;        <span class="comment">// full mrgArity. This is the last change to mrgArity</span></div>
<div class="line"><a name="l00498"></a><span class="lineno">  498</span>&#160;        <span class="comment">// N.B. We need to &quot;up&quot;-cast mrgArity here!</span></div>
<div class="line"><a name="l00499"></a><span class="lineno">  499</span>&#160;    <span class="keywordflow">if</span>(<span class="keyword">static_cast&lt;</span>TPIE_OS_OFFSET<span class="keyword">&gt;</span>(mrgArity)&gt;nRuns){</div>
<div class="line"><a name="l00500"></a><span class="lineno">  500</span>&#160;        <span class="comment">// N.B. We know that nRuns is small, so </span></div>
<div class="line"><a name="l00501"></a><span class="lineno">  501</span>&#160;        <span class="comment">//      it is safr to downcast.</span></div>
<div class="line"><a name="l00502"></a><span class="lineno">  502</span>&#160;        mrgArity=<span class="keyword">static_cast&lt;</span>TPIE_OS_SIZE_T<span class="keyword">&gt;</span>(nRuns);</div>
<div class="line"><a name="l00503"></a><span class="lineno">  503</span>&#160;    }</div>
<div class="line"><a name="l00504"></a><span class="lineno">  504</span>&#160; </div>
<div class="line"><a name="l00505"></a><span class="lineno">  505</span>&#160;    <span class="comment">// We should always end up with at least two runs</span></div>
<div class="line"><a name="l00506"></a><span class="lineno">  506</span>&#160;    <span class="comment">// otherwise why are we doing it externally?</span></div>
<div class="line"><a name="l00507"></a><span class="lineno">  507</span>&#160;    <a class="code" href="tpie__assert_8h.html#aa94b0c564b3fcb1afbe20c17fbaf95fd">tp_assert</a> (nRuns &gt; 1, <span class="stringliteral">&quot;Less than two runs to merge!&quot;</span>);</div>
<div class="line"><a name="l00508"></a><span class="lineno">  508</span>&#160;    <span class="comment">// Check that numbers are consistent with input size</span></div>
<div class="line"><a name="l00509"></a><span class="lineno">  509</span>&#160;    <a class="code" href="tpie__assert_8h.html#aa94b0c564b3fcb1afbe20c17fbaf95fd">tp_assert</a> (nRuns * nItemsPerRun - nInputItems &lt; nItemsPerRun,</div>
<div class="line"><a name="l00510"></a><span class="lineno">  510</span>&#160;               <span class="stringliteral">&quot;Total expected output size is too large.&quot;</span>);</div>
<div class="line"><a name="l00511"></a><span class="lineno">  511</span>&#160;    <a class="code" href="tpie__assert_8h.html#aa94b0c564b3fcb1afbe20c17fbaf95fd">tp_assert</a> (nInputItems - (nRuns - 1) * nItemsPerRun &lt;= nItemsPerRun,</div>
<div class="line"><a name="l00512"></a><span class="lineno">  512</span>&#160;               <span class="stringliteral">&quot;Total expected output size is too small.&quot;</span>);</div>
<div class="line"><a name="l00513"></a><span class="lineno">  513</span>&#160; </div>
<div class="line"><a name="l00514"></a><span class="lineno">  514</span>&#160;    TP_LOG_DEBUG_ID (<span class="stringliteral">&quot;Input stream has &quot;</span> &lt;&lt; nInputItems &lt;&lt; <span class="stringliteral">&quot; items&quot;</span>);</div>
<div class="line"><a name="l00515"></a><span class="lineno">  515</span>&#160;    TP_LOG_DEBUG (<span class="stringliteral">&quot;Max number of items per runs &quot;</span> &lt;&lt; <span class="keyword">static_cast&lt;</span>TPIE_OS_OUTPUT_SIZE_T<span class="keyword">&gt;</span>(nItemsPerRun) );</div>
<div class="line"><a name="l00516"></a><span class="lineno">  516</span>&#160;    TP_LOG_DEBUG (<span class="stringliteral">&quot;\nInitial number of runs &quot;</span> &lt;&lt; nRuns );</div>
<div class="line"><a name="l00517"></a><span class="lineno">  517</span>&#160;    TP_LOG_DEBUG (<span class="stringliteral">&quot;\nMerge arity is &quot;</span> &lt;&lt; <span class="keyword">static_cast&lt;</span>TPIE_OS_OUTPUT_SIZE_T<span class="keyword">&gt;</span>(mrgArity) &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span> );</div>
<div class="line"><a name="l00518"></a><span class="lineno">  518</span>&#160;}</div>
<div class="line"><a name="l00519"></a><span class="lineno">  519</span>&#160; </div>
<div class="line"><a name="l00520"></a><span class="lineno">  520</span>&#160;<span class="keyword">template</span>&lt;<span class="keyword">class</span> T, <span class="keyword">class</span> I, <span class="keyword">class</span> M&gt;</div>
<div class="line"><a name="l00521"></a><span class="lineno">  521</span>&#160;<span class="keywordtype">void</span> sort_manager&lt;T,I,M&gt;::partition_and_sort_runs(progress_indicator_base* indicator, <a class="code" href="classtpie_1_1array.html">tpie::array&lt;temp_file&gt;</a> &amp; temporaries){</div>
<div class="line"><a name="l00522"></a><span class="lineno">  522</span>&#160;    <span class="comment">// ********************************************************************</span></div>
<div class="line"><a name="l00523"></a><span class="lineno">  523</span>&#160;    <span class="comment">// * PHASE 3: Partition                                               *</span></div>
<div class="line"><a name="l00524"></a><span class="lineno">  524</span>&#160;    <span class="comment">// * Partition the input stream into nRuns of at most nItemsPerRun    *</span></div>
<div class="line"><a name="l00525"></a><span class="lineno">  525</span>&#160;    <span class="comment">// * and sort them, and write them to temporay output files.          *</span></div>
<div class="line"><a name="l00526"></a><span class="lineno">  526</span>&#160;    <span class="comment">// * The last run may have fewer than nItemsPerRun. To keep the number*</span></div>
<div class="line"><a name="l00527"></a><span class="lineno">  527</span>&#160;    <span class="comment">// * of files down and to support sequential I/O, we distribute the   *</span></div>
<div class="line"><a name="l00528"></a><span class="lineno">  528</span>&#160;    <span class="comment">// * nRuns evenly across mrgArity files, thus each file on disk holds *</span></div>
<div class="line"><a name="l00529"></a><span class="lineno">  529</span>&#160;    <span class="comment">// * multiple sorted runs.                                            *</span></div>
<div class="line"><a name="l00530"></a><span class="lineno">  530</span>&#160;    <span class="comment">// ********************************************************************</span></div>
<div class="line"><a name="l00531"></a><span class="lineno">  531</span>&#160; </div>
<div class="line"><a name="l00532"></a><span class="lineno">  532</span>&#160;    <span class="comment">// The mininum number of runs in each output stream</span></div>
<div class="line"><a name="l00533"></a><span class="lineno">  533</span>&#160;    <span class="comment">// some streams can have one additional run</span></div>
<div class="line"><a name="l00534"></a><span class="lineno">  534</span>&#160;    minRunsPerStream = nRuns/mrgArity;</div>
<div class="line"><a name="l00535"></a><span class="lineno">  535</span>&#160;    <span class="comment">// The number of extra runs or the number of streams that</span></div>
<div class="line"><a name="l00536"></a><span class="lineno">  536</span>&#160;    <span class="comment">// get one additional run. This is less than mrgArity and</span></div>
<div class="line"><a name="l00537"></a><span class="lineno">  537</span>&#160;    <span class="comment">// it is OK to downcast to an arity_t.</span></div>
<div class="line"><a name="l00538"></a><span class="lineno">  538</span>&#160;    nXtraRuns = <span class="keyword">static_cast&lt;</span><a class="code" href="namespacetpie.html#a90b015a1fcd16bdca3002ce6f6fe89eb">arity_t</a><span class="keyword">&gt;</span>(nRuns - minRunsPerStream*mrgArity);</div>
<div class="line"><a name="l00539"></a><span class="lineno">  539</span>&#160;    <a class="code" href="tpie__assert_8h.html#aa94b0c564b3fcb1afbe20c17fbaf95fd">tp_assert</a>(nXtraRuns&lt;mrgArity, <span class="stringliteral">&quot;Too many extra runs&quot;</span>);</div>
<div class="line"><a name="l00540"></a><span class="lineno">  540</span>&#160; </div>
<div class="line"><a name="l00541"></a><span class="lineno">  541</span>&#160;    <span class="comment">// The last run can have fewer than nItemsPerRun;</span></div>
<div class="line"><a name="l00542"></a><span class="lineno">  542</span>&#160;    <span class="comment">// general case</span></div>
<div class="line"><a name="l00543"></a><span class="lineno">  543</span>&#160;    nItemsInLastRun = <span class="keyword">static_cast&lt;</span>TPIE_OS_SIZE_T<span class="keyword">&gt;</span>(nInputItems % nItemsPerRun);</div>
<div class="line"><a name="l00544"></a><span class="lineno">  544</span>&#160;    <span class="keywordflow">if</span>(nItemsInLastRun==0){</div>
<div class="line"><a name="l00545"></a><span class="lineno">  545</span>&#160;        <span class="comment">// Input size is an exact multiple of nItemsPerStream</span></div>
<div class="line"><a name="l00546"></a><span class="lineno">  546</span>&#160;        nItemsInLastRun=nItemsPerRun;</div>
<div class="line"><a name="l00547"></a><span class="lineno">  547</span>&#160;    }</div>
<div class="line"><a name="l00548"></a><span class="lineno">  548</span>&#160; </div>
<div class="line"><a name="l00549"></a><span class="lineno">  549</span>&#160;    <span class="comment">// Initialize memory for the internal memory runs</span></div>
<div class="line"><a name="l00550"></a><span class="lineno">  550</span>&#160;    <span class="comment">// accounted for in phase 2:  (nItemsPerRun*size_of_sort_item) +</span></div>
<div class="line"><a name="l00551"></a><span class="lineno">  551</span>&#160;    <span class="comment">// space_overhead_sort</span></div>
<div class="line"><a name="l00552"></a><span class="lineno">  552</span>&#160;    m_internalSorter-&gt;allocate(nItemsPerRun);</div>
<div class="line"><a name="l00553"></a><span class="lineno">  553</span>&#160; </div>
<div class="line"><a name="l00554"></a><span class="lineno">  554</span>&#160;    TP_LOG_DEBUG_ID (<span class="stringliteral">&quot;Partitioning and forming sorted runs.&quot;</span>);</div>
<div class="line"><a name="l00555"></a><span class="lineno">  555</span>&#160; </div>
<div class="line"><a name="l00556"></a><span class="lineno">  556</span>&#160;    <span class="comment">// nItemsPerRun except for last run.</span></div>
<div class="line"><a name="l00557"></a><span class="lineno">  557</span>&#160;    nItemsInThisRun=nItemsPerRun;</div>
<div class="line"><a name="l00558"></a><span class="lineno">  558</span>&#160;        </div>
<div class="line"><a name="l00559"></a><span class="lineno">  559</span>&#160;    <span class="comment">// Rewind the input stream, we are about to begin</span></div>
<div class="line"><a name="l00560"></a><span class="lineno">  560</span>&#160;    inStream-&gt;seek(0);</div>
<div class="line"><a name="l00561"></a><span class="lineno">  561</span>&#160; </div>
<div class="line"><a name="l00562"></a><span class="lineno">  562</span>&#160;    <span class="comment">// ********************************************************************</span></div>
<div class="line"><a name="l00563"></a><span class="lineno">  563</span>&#160;    <span class="comment">// * Partition and make initial sorted runs                           *</span></div>
<div class="line"><a name="l00564"></a><span class="lineno">  564</span>&#160;    <span class="comment">// ********************************************************************</span></div>
<div class="line"><a name="l00565"></a><span class="lineno">  565</span>&#160;    TPIE_OS_OFFSET check_size = 0; <span class="comment">//for debugging</span></div>
<div class="line"><a name="l00566"></a><span class="lineno">  566</span>&#160; </div>
<div class="line"><a name="l00567"></a><span class="lineno">  567</span>&#160;    <span class="keywordflow">if</span> (indicator) </div>
<div class="line"><a name="l00568"></a><span class="lineno">  568</span>&#160;        indicator-&gt;init(nRuns*1000);</div>
<div class="line"><a name="l00569"></a><span class="lineno">  569</span>&#160;    </div>
<div class="line"><a name="l00570"></a><span class="lineno">  570</span>&#160;    <span class="keywordflow">for</span>(<a class="code" href="namespacetpie.html#a90b015a1fcd16bdca3002ce6f6fe89eb">arity_t</a> ii=0; ii&lt;mrgArity; ii++){   <span class="comment">//For each output stream</span></div>
<div class="line"><a name="l00571"></a><span class="lineno">  571</span>&#160;        <span class="comment">// Dynamically allocate the stream</span></div>
<div class="line"><a name="l00572"></a><span class="lineno">  572</span>&#160;        <span class="comment">// We account for these mmBytesPerStream in phase 2 (output stream)</span></div>
<div class="line"><a name="l00573"></a><span class="lineno">  573</span>&#160;        curOutputRunStream = tpie_new&lt;file_stream&lt;T&gt; &gt;();</div>
<div class="line"><a name="l00574"></a><span class="lineno">  574</span>&#160;        curOutputRunStream-&gt;open(temporaries[ii], <a class="code" href="namespacetpie.html#ae4856303ae847dc340972edc10ae224da8abc42d1617b26247565c881bbf365f4">access_write</a>);</div>
<div class="line"><a name="l00575"></a><span class="lineno">  575</span>&#160; </div>
<div class="line"><a name="l00576"></a><span class="lineno">  576</span>&#160;        <span class="comment">// How many runs should this stream get?</span></div>
<div class="line"><a name="l00577"></a><span class="lineno">  577</span>&#160;        <span class="comment">// extra runs go in the LAST nXtraRuns streams so that</span></div>
<div class="line"><a name="l00578"></a><span class="lineno">  578</span>&#160;        <span class="comment">// the one short run is always in the LAST output stream</span></div>
<div class="line"><a name="l00579"></a><span class="lineno">  579</span>&#160;        runsInStream = minRunsPerStream + ((ii &gt;= mrgArity-nXtraRuns)?1:0);</div>
<div class="line"><a name="l00580"></a><span class="lineno">  580</span>&#160; </div>
<div class="line"><a name="l00581"></a><span class="lineno">  581</span>&#160;        <span class="keywordflow">for</span>(TPIE_OS_OFFSET  jj=0; jj &lt; runsInStream; jj++ ) { <span class="comment">// For each run in this stream</span></div>
<div class="line"><a name="l00582"></a><span class="lineno">  582</span>&#160;            <span class="comment">// See if this is the last run</span></div>
<div class="line"><a name="l00583"></a><span class="lineno">  583</span>&#160;            <span class="keywordflow">if</span>( (ii==mrgArity-1) &amp;&amp; (jj==runsInStream-1)) {</div>
<div class="line"><a name="l00584"></a><span class="lineno">  584</span>&#160;                nItemsInThisRun=nItemsInLastRun;</div>
<div class="line"><a name="l00585"></a><span class="lineno">  585</span>&#160;            }</div>
<div class="line"><a name="l00586"></a><span class="lineno">  586</span>&#160; </div>
<div class="line"><a name="l00587"></a><span class="lineno">  587</span>&#160;            progress_indicator_subindicator sort_indicator(indicator, 1000);</div>
<div class="line"><a name="l00588"></a><span class="lineno">  588</span>&#160;            m_internalSorter-&gt;sort(inStream, curOutputRunStream, </div>
<div class="line"><a name="l00589"></a><span class="lineno">  589</span>&#160;                                   nItemsInThisRun, &amp;sort_indicator);</div>
<div class="line"><a name="l00590"></a><span class="lineno">  590</span>&#160;        } <span class="comment">// For each run in this stream</span></div>
<div class="line"><a name="l00591"></a><span class="lineno">  591</span>&#160;        </div>
<div class="line"><a name="l00592"></a><span class="lineno">  592</span>&#160;        <span class="comment">// All runs created for this stream, clean up</span></div>
<div class="line"><a name="l00593"></a><span class="lineno">  593</span>&#160;        TP_LOG_DEBUG_ID (<span class="stringliteral">&quot;Wrote &quot;</span> &lt;&lt; runsInStream &lt;&lt; <span class="stringliteral">&quot; runs and &quot;</span></div>
<div class="line"><a name="l00594"></a><span class="lineno">  594</span>&#160;                         &lt;&lt; curOutputRunStream-&gt;size() &lt;&lt; <span class="stringliteral">&quot; items to file &quot;</span> </div>
<div class="line"><a name="l00595"></a><span class="lineno">  595</span>&#160;                         &lt;&lt; <span class="keyword">static_cast&lt;</span>TPIE_OS_OUTPUT_SIZE_T<span class="keyword">&gt;</span>(ii));</div>
<div class="line"><a name="l00596"></a><span class="lineno">  596</span>&#160;        check_size+=curOutputRunStream-&gt;size();</div>
<div class="line"><a name="l00597"></a><span class="lineno">  597</span>&#160;        <a class="code" href="namespacetpie.html#aa3ddea8b15e5629039c62b1b5b26e7a9">tpie_delete</a>(curOutputRunStream);</div>
<div class="line"><a name="l00598"></a><span class="lineno">  598</span>&#160; </div>
<div class="line"><a name="l00599"></a><span class="lineno">  599</span>&#160;    }<span class="comment">//For each output stream</span></div>
<div class="line"><a name="l00600"></a><span class="lineno">  600</span>&#160;    <a class="code" href="tpie__assert_8h.html#aa94b0c564b3fcb1afbe20c17fbaf95fd">tp_assert</a>(check_size == nInputItems, <span class="stringliteral">&quot;item count mismatch&quot;</span>);</div>
<div class="line"><a name="l00601"></a><span class="lineno">  601</span>&#160; </div>
<div class="line"><a name="l00602"></a><span class="lineno">  602</span>&#160;    <span class="comment">// Done with partitioning and initial run formation</span></div>
<div class="line"><a name="l00603"></a><span class="lineno">  603</span>&#160;    <span class="comment">// free space associated with internal memory sorting</span></div>
<div class="line"><a name="l00604"></a><span class="lineno">  604</span>&#160;    m_internalSorter-&gt;deallocate();</div>
<div class="line"><a name="l00605"></a><span class="lineno">  605</span>&#160;    <span class="keywordflow">if</span>(use2xSpace){ </div>
<div class="line"><a name="l00606"></a><span class="lineno">  606</span>&#160;        <span class="comment">//recall outStream/inStream point to same file in this case</span></div>
<div class="line"><a name="l00607"></a><span class="lineno">  607</span>&#160;        inStream-&gt;truncate(0); <span class="comment">//free up disk space</span></div>
<div class="line"><a name="l00608"></a><span class="lineno">  608</span>&#160;        inStream-&gt;seek(0);</div>
<div class="line"><a name="l00609"></a><span class="lineno">  609</span>&#160;    } </div>
<div class="line"><a name="l00610"></a><span class="lineno">  610</span>&#160;    <span class="keywordflow">if</span> (indicator) indicator-&gt;done();</div>
<div class="line"><a name="l00611"></a><span class="lineno">  611</span>&#160;}</div>
<div class="line"><a name="l00612"></a><span class="lineno">  612</span>&#160; </div>
<div class="line"><a name="l00613"></a><span class="lineno">  613</span>&#160;<span class="keyword">template</span>&lt;<span class="keyword">class</span> T, <span class="keyword">class</span> I, <span class="keyword">class</span> M&gt;</div>
<div class="line"><a name="l00614"></a><span class="lineno">  614</span>&#160;<span class="keywordtype">void</span> sort_manager&lt;T,I,M&gt;::merge_to_output(progress_indicator_base* indicator, <a class="code" href="classtpie_1_1array.html">tpie::array&lt;temp_file&gt;</a> &amp; temporaries){</div>
<div class="line"><a name="l00615"></a><span class="lineno">  615</span>&#160;    <span class="comment">// ********************************************************************</span></div>
<div class="line"><a name="l00616"></a><span class="lineno">  616</span>&#160;    <span class="comment">// * PHASE 4: Merge                                                   *</span></div>
<div class="line"><a name="l00617"></a><span class="lineno">  617</span>&#160;    <span class="comment">// * Loop over all levels of the merge tree, reading mrgArity runs    *</span></div>
<div class="line"><a name="l00618"></a><span class="lineno">  618</span>&#160;    <span class="comment">// * at a time from the streams at the current level and distributing *</span></div>
<div class="line"><a name="l00619"></a><span class="lineno">  619</span>&#160;    <span class="comment">// * merged runs over mrgArity output streams one level up, until     *</span></div>
<div class="line"><a name="l00620"></a><span class="lineno">  620</span>&#160;    <span class="comment">// * a single output stream exists                                    *</span></div>
<div class="line"><a name="l00621"></a><span class="lineno">  621</span>&#160;    <span class="comment">// ********************************************************************</span></div>
<div class="line"><a name="l00622"></a><span class="lineno">  622</span>&#160; </div>
<div class="line"><a name="l00623"></a><span class="lineno">  623</span>&#160;    <span class="comment">// The input streams we from which will read sorted runs</span></div>
<div class="line"><a name="l00624"></a><span class="lineno">  624</span>&#160;    <span class="comment">// This Memory allocation accounted for in phase 2:</span></div>
<div class="line"><a name="l00625"></a><span class="lineno">  625</span>&#160;    <span class="comment">//   mrgArity*sizeof(stream&lt;T&gt;*) + space_overhead()[fixed cost]</span></div>
<div class="line"><a name="l00626"></a><span class="lineno">  626</span>&#160;    <a class="code" href="classtpie_1_1array.html">tpie::array&lt;tpie::unique_ptr&lt;file_stream&lt;T&gt;</a> &gt; &gt; mergeInputStreams(mrgArity);</div>
<div class="line"><a name="l00627"></a><span class="lineno">  627</span>&#160; </div>
<div class="line"><a name="l00628"></a><span class="lineno">  628</span>&#160;    TP_LOG_DEBUG_ID(<span class="stringliteral">&quot;Allocated &quot;</span> &lt;&lt; <span class="keyword">static_cast&lt;</span>TPIE_OS_OUTPUT_SIZE_T<span class="keyword">&gt;</span>(<span class="keyword">sizeof</span>(ami::stream&lt;T&gt;*)*mrgArity)</div>
<div class="line"><a name="l00629"></a><span class="lineno">  629</span>&#160;                    &lt;&lt; <span class="stringliteral">&quot; bytes for &quot;</span> &lt;&lt; <span class="keyword">static_cast&lt;</span>TPIE_OS_OUTPUT_SIZE_T<span class="keyword">&gt;</span>(mrgArity) &lt;&lt; <span class="stringliteral">&quot; merge input stream pointers.\n&quot;</span></div>
<div class="line"><a name="l00630"></a><span class="lineno">  630</span>&#160;                    &lt;&lt; <span class="stringliteral">&quot;Mem. avail. is &quot;</span> &lt;&lt; <a class="code" href="namespacetpie.html#ae82b3fc07d981325a56b68663c868a0d">consecutive_memory_available</a> ());</div>
<div class="line"><a name="l00631"></a><span class="lineno">  631</span>&#160; </div>
<div class="line"><a name="l00632"></a><span class="lineno">  632</span>&#160;    <span class="comment">// the number of iterations the main loop has gone through,</span></div>
<div class="line"><a name="l00633"></a><span class="lineno">  633</span>&#160;    <span class="comment">// at most the height of the merge tree log_{M/B}(N/B),</span></div>
<div class="line"><a name="l00634"></a><span class="lineno">  634</span>&#160;    <span class="comment">// typically 1 or 2</span></div>
<div class="line"><a name="l00635"></a><span class="lineno">  635</span>&#160;    <span class="keywordtype">int</span> mrgHeight  = 0;</div>
<div class="line"><a name="l00636"></a><span class="lineno">  636</span>&#160;    <span class="keywordtype">int</span> treeHeight = 0; <span class="comment">//for progress</span></div>
<div class="line"><a name="l00637"></a><span class="lineno">  637</span>&#160;    TPIE_OS_SIZE_T ii; <span class="comment">//index vars</span></div>
<div class="line"><a name="l00638"></a><span class="lineno">  638</span>&#160;    TPIE_OS_OFFSET jj; <span class="comment">//index vars</span></div>
<div class="line"><a name="l00639"></a><span class="lineno">  639</span>&#160; </div>
<div class="line"><a name="l00640"></a><span class="lineno">  640</span>&#160;    <span class="comment">// This Memory allocation accounted for in phase 2:</span></div>
<div class="line"><a name="l00641"></a><span class="lineno">  641</span>&#160;    <span class="comment">//   mrgArity*space_per_merge_item</span></div>
<div class="line"><a name="l00642"></a><span class="lineno">  642</span>&#160;    m_mergeHeap-&gt;allocate( mrgArity ); <span class="comment">//Allocate mem for mergeheap</span></div>
<div class="line"><a name="l00643"></a><span class="lineno">  643</span>&#160; </div>
<div class="line"><a name="l00644"></a><span class="lineno">  644</span>&#160;    <span class="comment">// *****************************************************************</span></div>
<div class="line"><a name="l00645"></a><span class="lineno">  645</span>&#160;    <span class="comment">// *                                                               *</span></div>
<div class="line"><a name="l00646"></a><span class="lineno">  646</span>&#160;    <span class="comment">// * The main loop.  At the outermost level we are looping over    *</span></div>
<div class="line"><a name="l00647"></a><span class="lineno">  647</span>&#160;    <span class="comment">// * levels of the merge tree.  Typically this will be very small, *</span></div>
<div class="line"><a name="l00648"></a><span class="lineno">  648</span>&#160;    <span class="comment">// * e.g. 1-3.  The final merge pass is handled outside the loop.  *</span></div>
<div class="line"><a name="l00649"></a><span class="lineno">  649</span>&#160;    <span class="comment">// * Future extension may want to do something special in the last *</span></div>
<div class="line"><a name="l00650"></a><span class="lineno">  650</span>&#160;    <span class="comment">// * merge                                                         *</span></div>
<div class="line"><a name="l00651"></a><span class="lineno">  651</span>&#160;    <span class="comment">// *                                                               *</span></div>
<div class="line"><a name="l00652"></a><span class="lineno">  652</span>&#160;    <span class="comment">// *****************************************************************</span></div>
<div class="line"><a name="l00653"></a><span class="lineno">  653</span>&#160; </div>
<div class="line"><a name="l00654"></a><span class="lineno">  654</span>&#160;    <span class="keywordflow">if</span> (indicator) {</div>
<div class="line"><a name="l00655"></a><span class="lineno">  655</span>&#160;        <span class="comment">//compute merge depth, number of passes over data</span></div>
<div class="line"><a name="l00656"></a><span class="lineno">  656</span>&#160;        treeHeight= <span class="keyword">static_cast&lt;</span><span class="keywordtype">int</span><span class="keyword">&gt;</span>(ceil(log(<span class="keyword">static_cast&lt;</span><span class="keywordtype">float</span><span class="keyword">&gt;</span>(nRuns)) /</div>
<div class="line"><a name="l00657"></a><span class="lineno">  657</span>&#160;                                          log(<span class="keyword">static_cast&lt;</span><span class="keywordtype">float</span><span class="keyword">&gt;</span>(mrgArity))));</div>
<div class="line"><a name="l00658"></a><span class="lineno">  658</span>&#160; </div>
<div class="line"><a name="l00659"></a><span class="lineno">  659</span>&#160;        indicator-&gt;set_range( nInputItems * treeHeight);</div>
<div class="line"><a name="l00660"></a><span class="lineno">  660</span>&#160;        indicator-&gt;init();</div>
<div class="line"><a name="l00661"></a><span class="lineno">  661</span>&#160;    }</div>
<div class="line"><a name="l00662"></a><span class="lineno">  662</span>&#160; </div>
<div class="line"><a name="l00663"></a><span class="lineno">  663</span>&#160;    <span class="comment">//nRuns is initially the number of runs we formed in partition_and_sort</span></div>
<div class="line"><a name="l00664"></a><span class="lineno">  664</span>&#160;    <span class="comment">//phase. nXtraRuns is initially the number of outputs streams that</span></div>
<div class="line"><a name="l00665"></a><span class="lineno">  665</span>&#160;    <span class="comment">//contain one extra run. Runs and nXtraRuns are updated as we </span></div>
<div class="line"><a name="l00666"></a><span class="lineno">  666</span>&#160;    <span class="comment">//complete a merge level. </span></div>
<div class="line"><a name="l00667"></a><span class="lineno">  667</span>&#160;    <span class="keywordflow">while</span> (nRuns &gt; TPIE_OS_OFFSET(mrgArity)) {</div>
<div class="line"><a name="l00668"></a><span class="lineno">  668</span>&#160;        <span class="comment">// if (m_indicator) {</span></div>
<div class="line"><a name="l00669"></a><span class="lineno">  669</span>&#160;        <span class="comment">//  std::string description;</span></div>
<div class="line"><a name="l00670"></a><span class="lineno">  670</span>&#160;        <span class="comment">//  std::stringstream buf;</span></div>
<div class="line"><a name="l00671"></a><span class="lineno">  671</span>&#160;        <span class="comment">//  buf &lt;&lt; &quot;Merge pass &quot; &lt;&lt; mrgHeight+1 &lt;&lt; &quot; of &quot; &lt;&lt; treeHeight &lt;&lt; &quot; &quot;;</span></div>
<div class="line"><a name="l00672"></a><span class="lineno">  672</span>&#160;        <span class="comment">//  buf &gt;&gt; description;</span></div>
<div class="line"><a name="l00673"></a><span class="lineno">  673</span>&#160;        <span class="comment">//     m_indicator-&gt;set_percentage_range(0, nInputItems);</span></div>
<div class="line"><a name="l00674"></a><span class="lineno">  674</span>&#160;        <span class="comment">//     m_indicator-&gt;init(description);</span></div>
<div class="line"><a name="l00675"></a><span class="lineno">  675</span>&#160;        <span class="comment">// }</span></div>
<div class="line"><a name="l00676"></a><span class="lineno">  676</span>&#160; </div>
<div class="line"><a name="l00677"></a><span class="lineno">  677</span>&#160;        <span class="comment">// We are not yet at the top of the merge tree</span></div>
<div class="line"><a name="l00678"></a><span class="lineno">  678</span>&#160;        <span class="comment">// Write merged runs to temporary output streams</span></div>
<div class="line"><a name="l00679"></a><span class="lineno">  679</span>&#160;        TP_LOG_DEBUG (<span class="stringliteral">&quot;Intermediate merge. level=&quot;</span>&lt;&lt;mrgHeight &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>);</div>
<div class="line"><a name="l00680"></a><span class="lineno">  680</span>&#160;    </div>
<div class="line"><a name="l00681"></a><span class="lineno">  681</span>&#160;        <span class="comment">// The number of output runs we will form after a mrgArity merge</span></div>
<div class="line"><a name="l00682"></a><span class="lineno">  682</span>&#160;        nRuns = (nRuns + mrgArity - 1)/mrgArity;</div>
<div class="line"><a name="l00683"></a><span class="lineno">  683</span>&#160; </div>
<div class="line"><a name="l00684"></a><span class="lineno">  684</span>&#160;        <span class="comment">// Distribute the new nRuns evenly across mrgArity (or fewer)</span></div>
<div class="line"><a name="l00685"></a><span class="lineno">  685</span>&#160;        <span class="comment">// output streams</span></div>
<div class="line"><a name="l00686"></a><span class="lineno">  686</span>&#160;        minRunsPerStream = nRuns/mrgArity;</div>
<div class="line"><a name="l00687"></a><span class="lineno">  687</span>&#160; </div>
<div class="line"><a name="l00688"></a><span class="lineno">  688</span>&#160;        <span class="comment">// We may have less mrgArity input runs for the last</span></div>
<div class="line"><a name="l00689"></a><span class="lineno">  689</span>&#160;        <span class="comment">// merged output run if the current set of merge streams has </span></div>
<div class="line"><a name="l00690"></a><span class="lineno">  690</span>&#160;        <span class="comment">// xtra runs</span></div>
<div class="line"><a name="l00691"></a><span class="lineno">  691</span>&#160;        <a class="code" href="namespacetpie.html#a90b015a1fcd16bdca3002ce6f6fe89eb">arity_t</a> mergeRunsInLastOutputRun=(nXtraRuns&gt;0) ? nXtraRuns : mrgArity;</div>
<div class="line"><a name="l00692"></a><span class="lineno">  692</span>&#160; </div>
<div class="line"><a name="l00693"></a><span class="lineno">  693</span>&#160;        <span class="comment">// The number of extra runs or the number of output streams that</span></div>
<div class="line"><a name="l00694"></a><span class="lineno">  694</span>&#160;        <span class="comment">// get one additional run. This is less than mrgArity and</span></div>
<div class="line"><a name="l00695"></a><span class="lineno">  695</span>&#160;        <span class="comment">// it is OK to downcast to an arity_t.</span></div>
<div class="line"><a name="l00696"></a><span class="lineno">  696</span>&#160;        nXtraRuns = <span class="keyword">static_cast&lt;</span><a class="code" href="namespacetpie.html#a90b015a1fcd16bdca3002ce6f6fe89eb">arity_t</a><span class="keyword">&gt;</span>(nRuns - minRunsPerStream*mrgArity);</div>
<div class="line"><a name="l00697"></a><span class="lineno">  697</span>&#160;        <a class="code" href="tpie__assert_8h.html#aa94b0c564b3fcb1afbe20c17fbaf95fd">tp_assert</a>(nXtraRuns&lt;mrgArity, <span class="stringliteral">&quot;Too many extra runs&quot;</span>);</div>
<div class="line"><a name="l00698"></a><span class="lineno">  698</span>&#160; </div>
<div class="line"><a name="l00699"></a><span class="lineno">  699</span>&#160;        <span class="comment">// How many Streams we will create at the next level</span></div>
<div class="line"><a name="l00700"></a><span class="lineno">  700</span>&#160;        <a class="code" href="namespacetpie.html#a90b015a1fcd16bdca3002ce6f6fe89eb">arity_t</a> nOutputStreams = (minRunsPerStream &gt; 0) ? mrgArity : nXtraRuns;</div>
<div class="line"><a name="l00701"></a><span class="lineno">  701</span>&#160; </div>
<div class="line"><a name="l00702"></a><span class="lineno">  702</span>&#160;        <a class="code" href="namespacetpie.html#a90b015a1fcd16bdca3002ce6f6fe89eb">arity_t</a> nRunsToMerge = mrgArity; <span class="comment">// may change for last output run</span></div>
<div class="line"><a name="l00703"></a><span class="lineno">  703</span>&#160; </div>
<div class="line"><a name="l00704"></a><span class="lineno">  704</span>&#160;        <span class="comment">// open the mrgArity Input streams from which to read runs</span></div>
<div class="line"><a name="l00705"></a><span class="lineno">  705</span>&#160;        <span class="keywordflow">for</span>(ii = 0; ii &lt; mrgArity; ii++){</div>
<div class="line"><a name="l00706"></a><span class="lineno">  706</span>&#160;            <span class="comment">// Dynamically allocate the stream</span></div>
<div class="line"><a name="l00707"></a><span class="lineno">  707</span>&#160;            <span class="comment">// We account for these mmBytesPerStream in phase 2</span></div>
<div class="line"><a name="l00708"></a><span class="lineno">  708</span>&#160;            <span class="comment">// (input stream to read from)</span></div>
<div class="line"><a name="l00709"></a><span class="lineno">  709</span>&#160;            file_stream&lt;T&gt; * stream = tpie_new&lt;file_stream&lt;T&gt; &gt;();</div>
<div class="line"><a name="l00710"></a><span class="lineno">  710</span>&#160;            mergeInputStreams[ii].reset(stream);</div>
<div class="line"><a name="l00711"></a><span class="lineno">  711</span>&#160;            stream-&gt;open(temporaries[mrgArity*(mrgHeight%2)+ii], <a class="code" href="namespacetpie.html#ae4856303ae847dc340972edc10ae224da784e7f294b96eeb2a04de576be8d83dd">access_read</a>);</div>
<div class="line"><a name="l00712"></a><span class="lineno">  712</span>&#160;            stream-&gt;seek(0);</div>
<div class="line"><a name="l00713"></a><span class="lineno">  713</span>&#160;        }</div>
<div class="line"><a name="l00714"></a><span class="lineno">  714</span>&#160; </div>
<div class="line"><a name="l00715"></a><span class="lineno">  715</span>&#160;        TPIE_OS_OFFSET check_size=0;</div>
<div class="line"><a name="l00716"></a><span class="lineno">  716</span>&#160;        <span class="comment">// For each new output stream, fill with merged runs.</span></div>
<div class="line"><a name="l00717"></a><span class="lineno">  717</span>&#160;        <span class="comment">// strange indexing is for the case that there are fewer than mrgArity</span></div>
<div class="line"><a name="l00718"></a><span class="lineno">  718</span>&#160;        <span class="comment">// output streams needed, and we use the LAST nOutputStreams. This</span></div>
<div class="line"><a name="l00719"></a><span class="lineno">  719</span>&#160;        <span class="comment">// always keeps the one possible short run in the LAST of the</span></div>
<div class="line"><a name="l00720"></a><span class="lineno">  720</span>&#160;        <span class="comment">// mrgArity output streams.</span></div>
<div class="line"><a name="l00721"></a><span class="lineno">  721</span>&#160;        TP_LOG_DEBUG(<span class="stringliteral">&quot;Writing &quot;</span> &lt;&lt; nRuns &lt;&lt; <span class="stringliteral">&quot; runs to &quot;</span> &lt;&lt; <span class="keyword">static_cast&lt;</span>TPIE_OS_OUTPUT_SIZE_T<span class="keyword">&gt;</span>(nOutputStreams)</div>
<div class="line"><a name="l00722"></a><span class="lineno">  722</span>&#160;                     &lt;&lt; <span class="stringliteral">&quot; output files.\nEach output file has at least &quot;</span></div>
<div class="line"><a name="l00723"></a><span class="lineno">  723</span>&#160;                     &lt;&lt; minRunsPerStream &lt;&lt; <span class="stringliteral">&quot; runs.\n&quot;</span>);</div>
<div class="line"><a name="l00724"></a><span class="lineno">  724</span>&#160; </div>
<div class="line"><a name="l00725"></a><span class="lineno">  725</span>&#160;        <span class="keywordflow">for</span>(ii = mrgArity-nOutputStreams; ii &lt; mrgArity; ii++){</div>
<div class="line"><a name="l00726"></a><span class="lineno">  726</span>&#160;            <span class="comment">// Dynamically allocate the stream</span></div>
<div class="line"><a name="l00727"></a><span class="lineno">  727</span>&#160;            <span class="comment">// We account for these mmBytesPerStream in phase 2</span></div>
<div class="line"><a name="l00728"></a><span class="lineno">  728</span>&#160;            <span class="comment">// (temp merge output stream)</span></div>
<div class="line"><a name="l00729"></a><span class="lineno">  729</span>&#160;            file_stream&lt;T&gt; curOutputRunStream;</div>
<div class="line"><a name="l00730"></a><span class="lineno">  730</span>&#160;            curOutputRunStream.open(temporaries[mrgArity*((mrgHeight+1)%2)+ii], <a class="code" href="namespacetpie.html#ae4856303ae847dc340972edc10ae224da8abc42d1617b26247565c881bbf365f4">access_write</a>);</div>
<div class="line"><a name="l00731"></a><span class="lineno">  731</span>&#160; </div>
<div class="line"><a name="l00732"></a><span class="lineno">  732</span>&#160;            <span class="comment">// How many runs should this stream get?</span></div>
<div class="line"><a name="l00733"></a><span class="lineno">  733</span>&#160;            <span class="comment">// extra runs go in the LAST nXtraRuns streams so that</span></div>
<div class="line"><a name="l00734"></a><span class="lineno">  734</span>&#160;            <span class="comment">// the one short run is always in the LAST output stream</span></div>
<div class="line"><a name="l00735"></a><span class="lineno">  735</span>&#160;            runsInStream = minRunsPerStream + ((ii &gt;= mrgArity-nXtraRuns)?1:0);</div>
<div class="line"><a name="l00736"></a><span class="lineno">  736</span>&#160;            TP_LOG_DEBUG(<span class="stringliteral">&quot;Writing &quot;</span> &lt;&lt; <span class="keyword">static_cast&lt;</span>TPIE_OS_OUTPUT_SIZE_T<span class="keyword">&gt;</span>(runsInStream) &lt;&lt; <span class="stringliteral">&quot; runs to output &quot;</span></div>
<div class="line"><a name="l00737"></a><span class="lineno">  737</span>&#160;                         &lt;&lt; <span class="stringliteral">&quot; file &quot;</span> &lt;&lt; <span class="keyword">static_cast&lt;</span>TPIE_OS_OUTPUT_SIZE_T<span class="keyword">&gt;</span>(ii) &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>);</div>
<div class="line"><a name="l00738"></a><span class="lineno">  738</span>&#160;            <span class="keywordflow">for</span>( jj=0; jj &lt; runsInStream; jj++ ) { <span class="comment">// For each run in this stream</span></div>
<div class="line"><a name="l00739"></a><span class="lineno">  739</span>&#160;                <span class="comment">// See if this is the last run.</span></div>
<div class="line"><a name="l00740"></a><span class="lineno">  740</span>&#160;                <span class="keywordflow">if</span>( (ii==mrgArity-1) &amp;&amp; (jj==runsInStream-1)) {</div>
<div class="line"><a name="l00741"></a><span class="lineno">  741</span>&#160;                    nRunsToMerge=mergeRunsInLastOutputRun;</div>
<div class="line"><a name="l00742"></a><span class="lineno">  742</span>&#160;                }</div>
<div class="line"><a name="l00743"></a><span class="lineno">  743</span>&#160;                <span class="comment">// Merge runs to curOutputRunStream</span></div>
<div class="line"><a name="l00744"></a><span class="lineno">  744</span>&#160;                single_merge(mergeInputStreams.find(mrgArity-nRunsToMerge),</div>
<div class="line"><a name="l00745"></a><span class="lineno">  745</span>&#160;                             mergeInputStreams.find(mrgArity),</div>
<div class="line"><a name="l00746"></a><span class="lineno">  746</span>&#160;                             &amp;curOutputRunStream, </div>
<div class="line"><a name="l00747"></a><span class="lineno">  747</span>&#160;                             nItemsPerRun, indicator); </div>
<div class="line"><a name="l00748"></a><span class="lineno">  748</span>&#160;            } <span class="comment">// For each output run in this stream</span></div>
<div class="line"><a name="l00749"></a><span class="lineno">  749</span>&#160; </div>
<div class="line"><a name="l00750"></a><span class="lineno">  750</span>&#160;            <span class="comment">// Commit new output stream to disk</span></div>
<div class="line"><a name="l00751"></a><span class="lineno">  751</span>&#160;            TP_LOG_DEBUG(<span class="stringliteral">&quot;Wrote &quot;</span> &lt;&lt; <span class="keyword">static_cast&lt;</span>TPIE_OS_OUTPUT_SIZE_T<span class="keyword">&gt;</span>(runsInStream) &lt;&lt; <span class="stringliteral">&quot; runs and &quot;</span></div>
<div class="line"><a name="l00752"></a><span class="lineno">  752</span>&#160;                         &lt;&lt; curOutputRunStream.size() &lt;&lt; <span class="stringliteral">&quot; items &quot;</span> </div>
<div class="line"><a name="l00753"></a><span class="lineno">  753</span>&#160;                         &lt;&lt; <span class="stringliteral">&quot;to file &quot;</span> &lt;&lt; <span class="keyword">static_cast&lt;</span>TPIE_OS_OUTPUT_SIZE_T<span class="keyword">&gt;</span>(ii) &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>);</div>
<div class="line"><a name="l00754"></a><span class="lineno">  754</span>&#160;            check_size+=curOutputRunStream.size();</div>
<div class="line"><a name="l00755"></a><span class="lineno">  755</span>&#160;        } <span class="comment">// For each new output stream</span></div>
<div class="line"><a name="l00756"></a><span class="lineno">  756</span>&#160; </div>
<div class="line"><a name="l00757"></a><span class="lineno">  757</span>&#160;        <a class="code" href="tpie__assert_8h.html#aa94b0c564b3fcb1afbe20c17fbaf95fd">tp_assert</a>(check_size==nInputItems, <span class="stringliteral">&quot;item count mismatch in merge&quot;</span>);</div>
<div class="line"><a name="l00758"></a><span class="lineno">  758</span>&#160;        <span class="comment">// All output streams created/filled.</span></div>
<div class="line"><a name="l00759"></a><span class="lineno">  759</span>&#160;        <span class="comment">// Clean up, go up to next level</span></div>
<div class="line"><a name="l00760"></a><span class="lineno">  760</span>&#160; </div>
<div class="line"><a name="l00761"></a><span class="lineno">  761</span>&#160;        <span class="comment">// Delete temp input merge streams</span></div>
<div class="line"><a name="l00762"></a><span class="lineno">  762</span>&#160;        <span class="keywordflow">for</span>(ii = 0; ii &lt; mrgArity; ii++) {</div>
<div class="line"><a name="l00763"></a><span class="lineno">  763</span>&#160;            mergeInputStreams[ii].reset();</div>
<div class="line"><a name="l00764"></a><span class="lineno">  764</span>&#160;            temporaries[mrgArity*(mrgHeight%2)+ii].free();</div>
<div class="line"><a name="l00765"></a><span class="lineno">  765</span>&#160;        }</div>
<div class="line"><a name="l00766"></a><span class="lineno">  766</span>&#160;        <span class="comment">// Update run lengths</span></div>
<div class="line"><a name="l00767"></a><span class="lineno">  767</span>&#160;        nItemsPerRun=mrgArity*nItemsPerRun; <span class="comment">//except for maybe last run</span></div>
<div class="line"><a name="l00768"></a><span class="lineno">  768</span>&#160;        mrgHeight++; <span class="comment">// moving up a level</span></div>
<div class="line"><a name="l00769"></a><span class="lineno">  769</span>&#160;    } <span class="comment">// while (nRuns &gt; mrgArity)</span></div>
<div class="line"><a name="l00770"></a><span class="lineno">  770</span>&#160; </div>
<div class="line"><a name="l00771"></a><span class="lineno">  771</span>&#160;    <a class="code" href="tpie__assert_8h.html#aa94b0c564b3fcb1afbe20c17fbaf95fd">tp_assert</a>( nRuns &gt; 1, <span class="stringliteral">&quot;Not enough runs to merge to final output&quot;</span>);</div>
<div class="line"><a name="l00772"></a><span class="lineno">  772</span>&#160;    <a class="code" href="tpie__assert_8h.html#aa94b0c564b3fcb1afbe20c17fbaf95fd">tp_assert</a>( nRuns &lt;= TPIE_OS_OFFSET(mrgArity), <span class="stringliteral">&quot;Too many runs to merge to final output&quot;</span>);</div>
<div class="line"><a name="l00773"></a><span class="lineno">  773</span>&#160; </div>
<div class="line"><a name="l00774"></a><span class="lineno">  774</span>&#160;    <span class="comment">// We are at the last merge phase, write to specified output stream</span></div>
<div class="line"><a name="l00775"></a><span class="lineno">  775</span>&#160;    <span class="comment">// Open up the nRuns final merge streams to merge</span></div>
<div class="line"><a name="l00776"></a><span class="lineno">  776</span>&#160;    <span class="comment">// These runs are packed in the LAST nRuns elements of the array</span></div>
<div class="line"><a name="l00777"></a><span class="lineno">  777</span>&#160;    <span class="comment">// nRuns is small, so it is safe to downcast.</span></div>
<div class="line"><a name="l00778"></a><span class="lineno">  778</span>&#160;    TP_LOG_DEBUG_ID (<span class="stringliteral">&quot;Final merge. level=&quot;</span>&lt;&lt;mrgHeight);</div>
<div class="line"><a name="l00779"></a><span class="lineno">  779</span>&#160;    TP_LOG_DEBUG(<span class="stringliteral">&quot;Merge runs left=&quot;</span>&lt;&lt;nRuns&lt;&lt;<span class="stringliteral">&quot;\n&quot;</span>);</div>
<div class="line"><a name="l00780"></a><span class="lineno">  780</span>&#160;    <span class="keywordflow">for</span>(ii = mrgArity-<span class="keyword">static_cast&lt;</span>TPIE_OS_SIZE_T<span class="keyword">&gt;</span>(nRuns); ii &lt; mrgArity; ii++){</div>
<div class="line"><a name="l00781"></a><span class="lineno">  781</span>&#160;        <span class="comment">/* Dynamically allocate the stream</span></div>
<div class="line"><a name="l00782"></a><span class="lineno">  782</span>&#160;<span class="comment">           We account for these mmBytesPerStream in phase 2 </span></div>
<div class="line"><a name="l00783"></a><span class="lineno">  783</span>&#160;<span class="comment">           (input stream to read from)</span></div>
<div class="line"><a name="l00784"></a><span class="lineno">  784</span>&#160;<span class="comment">           Put LAST nRuns files in FIRST nRuns spots here</span></div>
<div class="line"><a name="l00785"></a><span class="lineno">  785</span>&#160;<span class="comment">           either one of mergeInputStreams loading or the call to</span></div>
<div class="line"><a name="l00786"></a><span class="lineno">  786</span>&#160;<span class="comment">           single_merge is a little messy. I put the mess here. (abd) */</span></div>
<div class="line"><a name="l00787"></a><span class="lineno">  787</span>&#160;        TP_LOG_DEBUG (<span class="stringliteral">&quot;Putting merge stream &quot;</span>&lt;&lt; <span class="keyword">static_cast&lt;</span>TPIE_OS_OUTPUT_SIZE_T<span class="keyword">&gt;</span>(ii) &lt;&lt; <span class="stringliteral">&quot; in slot &quot;</span></div>
<div class="line"><a name="l00788"></a><span class="lineno">  788</span>&#160;                      &lt;&lt; <span class="keyword">static_cast&lt;</span>TPIE_OS_OUTPUT_SIZE_T<span class="keyword">&gt;</span>(ii-(mrgArity-<span class="keyword">static_cast&lt;</span>TPIE_OS_SIZE_T<span class="keyword">&gt;</span>(nRuns))) &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>);</div>
<div class="line"><a name="l00789"></a><span class="lineno">  789</span>&#160;        file_stream&lt;T&gt; * stream = tpie_new&lt;file_stream&lt;T&gt; &gt;();</div>
<div class="line"><a name="l00790"></a><span class="lineno">  790</span>&#160;        mergeInputStreams[ii-(mrgArity-<span class="keyword">static_cast&lt;</span>TPIE_OS_SIZE_T<span class="keyword">&gt;</span>(nRuns))].reset(stream);</div>
<div class="line"><a name="l00791"></a><span class="lineno">  791</span>&#160;        stream-&gt;open(temporaries[mrgArity*(mrgHeight%2)+ii], <a class="code" href="namespacetpie.html#ae4856303ae847dc340972edc10ae224da784e7f294b96eeb2a04de576be8d83dd">access_read</a>);</div>
<div class="line"><a name="l00792"></a><span class="lineno">  792</span>&#160;        stream-&gt;seek(0);</div>
<div class="line"><a name="l00793"></a><span class="lineno">  793</span>&#160;    }</div>
<div class="line"><a name="l00794"></a><span class="lineno">  794</span>&#160; </div>
<div class="line"><a name="l00795"></a><span class="lineno">  795</span>&#160;    <span class="comment">// Merge last remaining runs to the output stream.</span></div>
<div class="line"><a name="l00796"></a><span class="lineno">  796</span>&#160;    <span class="comment">// mergeInputStreams is address( address (the first input stream) )</span></div>
<div class="line"><a name="l00797"></a><span class="lineno">  797</span>&#160;    <span class="comment">// N.B. nRuns is small, so it is safe to downcast.</span></div>
<div class="line"><a name="l00798"></a><span class="lineno">  798</span>&#160;    single_merge(mergeInputStreams.begin(), </div>
<div class="line"><a name="l00799"></a><span class="lineno">  799</span>&#160;                 mergeInputStreams.find((<span class="keywordtype">size_t</span>)nRuns),</div>
<div class="line"><a name="l00800"></a><span class="lineno">  800</span>&#160;                 outStream, -1, indicator);</div>
<div class="line"><a name="l00801"></a><span class="lineno">  801</span>&#160; </div>
<div class="line"><a name="l00802"></a><span class="lineno">  802</span>&#160;    <span class="keywordflow">if</span> (indicator) indicator-&gt;done();</div>
<div class="line"><a name="l00803"></a><span class="lineno">  803</span>&#160;    <a class="code" href="tpie__assert_8h.html#aa94b0c564b3fcb1afbe20c17fbaf95fd">tp_assert</a>((TPIE_OS_OFFSET)outStream-&gt;size() == nInputItems, <span class="stringliteral">&quot;item count mismatch&quot;</span>);</div>
<div class="line"><a name="l00804"></a><span class="lineno">  804</span>&#160; </div>
<div class="line"><a name="l00805"></a><span class="lineno">  805</span>&#160;    TP_LOG_DEBUG(<span class="stringliteral">&quot;merge cleanup\n&quot;</span>);</div>
<div class="line"><a name="l00806"></a><span class="lineno">  806</span>&#160; </div>
<div class="line"><a name="l00807"></a><span class="lineno">  807</span>&#160;    <span class="comment">// Delete stream ptr arrays</span></div>
<div class="line"><a name="l00808"></a><span class="lineno">  808</span>&#160;    mergeInputStreams.resize(0);</div>
<div class="line"><a name="l00809"></a><span class="lineno">  809</span>&#160; </div>
<div class="line"><a name="l00810"></a><span class="lineno">  810</span>&#160;    <span class="comment">// Deallocate the merge heap, free up memory</span></div>
<div class="line"><a name="l00811"></a><span class="lineno">  811</span>&#160;    m_mergeHeap-&gt;deallocate();</div>
<div class="line"><a name="l00812"></a><span class="lineno">  812</span>&#160;    TP_LOG_DEBUG_ID (<span class="stringliteral">&quot;Number of passes incl run formation is &quot;</span> &lt;&lt;</div>
<div class="line"><a name="l00813"></a><span class="lineno">  813</span>&#160;                     mrgHeight+2 ); </div>
<div class="line"><a name="l00814"></a><span class="lineno">  814</span>&#160;    TP_LOG_DEBUG(<span class="stringliteral">&quot;AMI_partition_and_merge END\n&quot;</span>);</div>
<div class="line"><a name="l00815"></a><span class="lineno">  815</span>&#160;}</div>
<div class="line"><a name="l00816"></a><span class="lineno">  816</span>&#160; </div>
<div class="line"><a name="l00817"></a><span class="lineno">  817</span>&#160;<span class="keyword">template</span>&lt;<span class="keyword">class</span> T, <span class="keyword">class</span> I, <span class="keyword">class</span> M&gt;</div>
<div class="line"><a name="l00818"></a><span class="lineno">  818</span>&#160;<span class="keywordtype">void</span> sort_manager&lt;T,I,M&gt;::single_merge( </div>
<div class="line"><a name="l00819"></a><span class="lineno">  819</span>&#160;    <span class="keyword">typename</span> <a class="code" href="classtpie_1_1array.html">tpie::array</a>&lt;<a class="code" href="namespacetpie.html#abeaddf0be84ea6bc461a97d5ebe184bd">tpie::unique_ptr</a>&lt;file_stream&lt;T&gt; &gt; &gt;::iterator start,</div>
<div class="line"><a name="l00820"></a><span class="lineno">  820</span>&#160;    <span class="keyword">typename</span> <a class="code" href="classtpie_1_1array.html">tpie::array</a>&lt;<a class="code" href="namespacetpie.html#abeaddf0be84ea6bc461a97d5ebe184bd">tpie::unique_ptr</a>&lt;file_stream&lt;T&gt; &gt; &gt;::iterator end,</div>
<div class="line"><a name="l00821"></a><span class="lineno">  821</span>&#160;    file_stream &lt; T &gt;*outStream, TPIE_OS_OFFSET cutoff, progress_indicator_base* indicator)</div>
<div class="line"><a name="l00822"></a><span class="lineno">  822</span>&#160;{</div>
<div class="line"><a name="l00823"></a><span class="lineno">  823</span>&#160; </div>
<div class="line"><a name="l00824"></a><span class="lineno">  824</span>&#160;    <a class="code" href="namespacetpie_1_1ami.html#afbbca450b4b82b213b146d8816eb3c06">merge_sorted_runs</a>(start, end, outStream, m_mergeHeap,</div>
<div class="line"><a name="l00825"></a><span class="lineno">  825</span>&#160;                      cutoff, indicator);</div>
<div class="line"><a name="l00826"></a><span class="lineno">  826</span>&#160;}</div>
<div class="line"><a name="l00827"></a><span class="lineno">  827</span>&#160; </div>
<div class="line"><a name="l00828"></a><span class="lineno">  828</span>&#160; </div>
<div class="line"><a name="l00829"></a><span class="lineno">  829</span>&#160;}  <span class="comment">//  tpie namespace</span></div>
<div class="line"><a name="l00830"></a><span class="lineno">  830</span>&#160; </div>
<div class="line"><a name="l00831"></a><span class="lineno">  831</span>&#160;<span class="preprocessor">#endif // _TPIE_AMI_SORT_MANAGER_H </span></div>
</div><!-- fragment --></div><!-- contents -->
</div><!-- doc-content -->
<div class="ttc" id="anamespacetpie_html_ae4856303ae847dc340972edc10ae224da8abc42d1617b26247565c881bbf365f4"><div class="ttname"><a href="namespacetpie.html#ae4856303ae847dc340972edc10ae224da8abc42d1617b26247565c881bbf365f4">tpie::access_write</a></div><div class="ttdeci">@ access_write</div><div class="ttdoc">Open a file for writing only, content is truncated.</div><div class="ttdef"><b>Definition:</b> <a href="access__type_8h_source.html#l00033">access_type.h:33</a></div></div>
<div class="ttc" id="ainternal__sort_8h_html"><div class="ttname"><a href="internal__sort_8h.html">internal_sort.h</a></div></div>
<div class="ttc" id="aclasstpie_1_1sort__manager_html"><div class="ttname"><a href="classtpie_1_1sort__manager.html">tpie::sort_manager</a></div><div class="ttdoc">A class of manager objects for merge sorting objects of type T.</div><div class="ttdef"><b>Definition:</b> <a href="sort__manager_8h_source.html#l00060">sort_manager.h:60</a></div></div>
<div class="ttc" id="aclasstpie_1_1progress__indicator__base_html"><div class="ttname"><a href="classtpie_1_1progress__indicator__base.html">tpie::progress_indicator_base</a></div><div class="ttdoc">The base class for indicating the progress of some task.</div><div class="ttdef"><b>Definition:</b> <a href="progress__indicator__base_8h_source.html#l00062">progress_indicator_base.h:62</a></div></div>
<div class="ttc" id="anamespacetpie_html_af7bd11f9ca8b3252ee4fd9d7f48c05a2"><div class="ttname"><a href="namespacetpie.html#af7bd11f9ca8b3252ee4fd9d7f48c05a2">tpie::sort</a></div><div class="ttdeci">void sort(uncompressed_stream&lt; T &gt; &amp;instream, uncompressed_stream&lt; T &gt; &amp;outstream, Compare comp, progress_indicator_base &amp;indicator)</div><div class="ttdoc">Sort elements of a stream using the given STL-style comparator object.</div><div class="ttdef"><b>Definition:</b> <a href="sort_8h_source.html#l00141">sort.h:141</a></div></div>
<div class="ttc" id="atpie__assert_8h_html"><div class="ttname"><a href="tpie__assert_8h.html">tpie_assert.h</a></div></div>
<div class="ttc" id="aportability_8h_html"><div class="ttname"><a href="portability_8h.html">portability.h</a></div></div>
<div class="ttc" id="anamespacetpie_html_ae82b3fc07d981325a56b68663c868a0d"><div class="ttname"><a href="namespacetpie.html#ae82b3fc07d981325a56b68663c868a0d">tpie::consecutive_memory_available</a></div><div class="ttdeci">TPIE_EXPORT size_t consecutive_memory_available(size_t granularity=5 *1024 *1024)</div><div class="ttdoc">Find the largest amount of memory that can be allocated as a single chunk.</div></div>
<div class="ttc" id="aclasstpie_1_1file__stream_html_af5f0c0a38832561a99d1478377cd1eb9"><div class="ttname"><a href="classtpie_1_1file__stream.html#af5f0c0a38832561a99d1478377cd1eb9">tpie::file_stream::read</a></div><div class="ttdeci">const T &amp; read()</div><div class="ttdoc">Reads next item from stream if can_read() == true.</div><div class="ttdef"><b>Definition:</b> <a href="compressed_2stream_8h_source.html#l00425">stream.h:425</a></div></div>
<div class="ttc" id="aclasstpie_1_1array_html"><div class="ttname"><a href="classtpie_1_1array.html">tpie::array</a></div><div class="ttdoc">A generic array with a fixed size.</div><div class="ttdef"><b>Definition:</b> <a href="array_8h_source.html#l00149">array.h:149</a></div></div>
<div class="ttc" id="atempname_8h_html"><div class="ttname"><a href="tempname_8h.html">tempname.h</a></div></div>
<div class="ttc" id="aclasstpie_1_1resource__manager_html_a9fc95070beb5c44f757b6f31fea80d2b"><div class="ttname"><a href="classtpie_1_1resource__manager.html#a9fc95070beb5c44f757b6f31fea80d2b">tpie::resource_manager::available</a></div><div class="ttdeci">size_t available() const noexcept</div><div class="ttdoc">Return the amount of the resource still available to be assigned.</div></div>
<div class="ttc" id="aclasstpie_1_1file__stream_html"><div class="ttname"><a href="classtpie_1_1file__stream.html">tpie::file_stream</a></div><div class="ttdoc">Compressed stream.</div><div class="ttdef"><b>Definition:</b> <a href="compressed_2predeclare_8h_source.html#l00049">predeclare.h:49</a></div></div>
<div class="ttc" id="anamespacetpie_html_abeaddf0be84ea6bc461a97d5ebe184bd"><div class="ttname"><a href="namespacetpie.html#abeaddf0be84ea6bc461a97d5ebe184bd">tpie::unique_ptr</a></div><div class="ttdeci">std::unique_ptr&lt; T, tpie_deleter &gt; unique_ptr</div><div class="ttdoc">like std::unique_ptr, but delete the object with tpie_delete.</div><div class="ttdef"><b>Definition:</b> <a href="memory_8h_source.html#l00311">memory.h:311</a></div></div>
<div class="ttc" id="aarray_8h_html"><div class="ttname"><a href="array_8h.html">array.h</a></div></div>
<div class="ttc" id="afractional__progress_8h_html_a63529a42767e2b1fb6cbc269acbf12f6"><div class="ttname"><a href="fractional__progress_8h.html#a63529a42767e2b1fb6cbc269acbf12f6">TPIE_FSI</a></div><div class="ttdeci">#define TPIE_FSI</div><div class="ttdef"><b>Definition:</b> <a href="fractional__progress_8h_source.html#l00038">fractional_progress.h:38</a></div></div>
<div class="ttc" id="astructtpie_1_1exception_html"><div class="ttname"><a href="structtpie_1_1exception.html">tpie::exception</a></div><div class="ttdef"><b>Definition:</b> <a href="exception_8h_source.html#l00033">exception.h:33</a></div></div>
<div class="ttc" id="atpie__assert_8h_html_aa94b0c564b3fcb1afbe20c17fbaf95fd"><div class="ttname"><a href="tpie__assert_8h.html#aa94b0c564b3fcb1afbe20c17fbaf95fd">tp_assert</a></div><div class="ttdeci">#define tp_assert(condition, message)</div><div class="ttdef"><b>Definition:</b> <a href="tpie__assert_8h_source.html#l00065">tpie_assert.h:65</a></div></div>
<div class="ttc" id="anamespacetpie_1_1ami_html_afbbca450b4b82b213b146d8816eb3c06"><div class="ttname"><a href="namespacetpie_1_1ami.html#afbbca450b4b82b213b146d8816eb3c06">tpie::ami::merge_sorted_runs</a></div><div class="ttdeci">void merge_sorted_runs(typename tpie::array&lt; tpie::unique_ptr&lt; file_stream&lt; T &gt; &gt; &gt;::iterator start, typename tpie::array&lt; tpie::unique_ptr&lt; file_stream&lt; T &gt; &gt; &gt;::iterator end, file_stream&lt; T &gt; *outStream, M *MergeHeap, TPIE_OS_OFFSET cutoff=-1, progress_indicator_base *indicator=NULL)</div><div class="ttdoc">This is a common merge routine for all of the AMI_merge_sorted, AMI_ptr_merge_sorted and AMI_key_merg...</div><div class="ttdef"><b>Definition:</b> <a href="merge__sorted__runs_8h_source.html#l00073">merge_sorted_runs.h:73</a></div></div>
<div class="ttc" id="aclasstpie_1_1fractional__subindicator_html"><div class="ttname"><a href="classtpie_1_1fractional__subindicator.html">tpie::fractional_subindicator</a></div><div class="ttdoc">Subindicator for fractional progress reporting.</div><div class="ttdef"><b>Definition:</b> <a href="fractional__progress_8h_source.html#l00057">fractional_progress.h:57</a></div></div>
<div class="ttc" id="anamespacetpie_html_aa3ddea8b15e5629039c62b1b5b26e7a9"><div class="ttname"><a href="namespacetpie.html#aa3ddea8b15e5629039c62b1b5b26e7a9">tpie::tpie_delete</a></div><div class="ttdeci">void tpie_delete(T *p)</div><div class="ttdoc">Delete an object allocated with tpie_new.</div><div class="ttdef"><b>Definition:</b> <a href="memory_8h_source.html#l00280">memory.h:280</a></div></div>
<div class="ttc" id="amerge__sorted__runs_8h_html"><div class="ttname"><a href="merge__sorted__runs_8h.html">merge_sorted_runs.h</a></div></div>
<div class="ttc" id="aclasstpie_1_1tempname_html_ad449b140eaf23781a40c26257d8710ab"><div class="ttname"><a href="classtpie_1_1tempname.html#ad449b140eaf23781a40c26257d8710ab">tpie::tempname::tpie_name</a></div><div class="ttdeci">static std::string tpie_name(const std::string &amp;post_base=&quot;&quot;, const std::string &amp;dir=&quot;&quot;, const std::string &amp;ext=&quot;&quot;)</div><div class="ttdoc">Generate path for a new temporary file.</div></div>
<div class="ttc" id="aclasstpie_1_1sort__manager_html_ad5cabd9a2f649c29dc7cdf95c39e271b"><div class="ttname"><a href="classtpie_1_1sort__manager.html#ad5cabd9a2f649c29dc7cdf95c39e271b">tpie::sort_manager::sort</a></div><div class="ttdeci">void sort(file_stream&lt; T &gt; *in, file_stream&lt; T &gt; *out, progress_indicator_base *indicator=NULL)</div><div class="ttdoc">Sort in stream to out stream an save in stream (uses 3x space)</div><div class="ttdef"><b>Definition:</b> <a href="sort__manager_8h_source.html#l00176">sort_manager.h:176</a></div></div>
<div class="ttc" id="amergeheap_8h_html"><div class="ttname"><a href="mergeheap_8h.html">mergeheap.h</a></div></div>
<div class="ttc" id="aclasstpie_1_1fractional__progress_html"><div class="ttname"><a href="classtpie_1_1fractional__progress.html">tpie::fractional_progress</a></div><div class="ttdoc">Fractional progress reporter.</div><div class="ttdef"><b>Definition:</b> <a href="fractional__progress_8h_source.html#l00108">fractional_progress.h:108</a></div></div>
<div class="ttc" id="aprogress__indicator__base_8h_html"><div class="ttname"><a href="progress__indicator__base_8h.html">progress_indicator_base.h</a></div></div>
<div class="ttc" id="anamespacetpie_html_aee9b06be9e89dab272a40aae7f5d81c6"><div class="ttname"><a href="namespacetpie.html#aee9b06be9e89dab272a40aae7f5d81c6">tpie::get_file_manager</a></div><div class="ttdeci">TPIE_EXPORT file_manager &amp; get_file_manager()</div><div class="ttdoc">Return a reference to the file manager.</div></div>
<div class="ttc" id="anamespacetpie_html"><div class="ttname"><a href="namespacetpie.html">tpie</a></div><div class="ttdef"><b>Definition:</b> <a href="access__type_8h_source.html#l00026">access_type.h:26</a></div></div>
<div class="ttc" id="anamespacetpie_html_ae4856303ae847dc340972edc10ae224da784e7f294b96eeb2a04de576be8d83dd"><div class="ttname"><a href="namespacetpie.html#ae4856303ae847dc340972edc10ae224da784e7f294b96eeb2a04de576be8d83dd">tpie::access_read</a></div><div class="ttdeci">@ access_read</div><div class="ttdoc">Open a file for reading.</div><div class="ttdef"><b>Definition:</b> <a href="access__type_8h_source.html#l00031">access_type.h:31</a></div></div>
<div class="ttc" id="anamespacetpie_html_a90b015a1fcd16bdca3002ce6f6fe89eb"><div class="ttname"><a href="namespacetpie.html#a90b015a1fcd16bdca3002ce6f6fe89eb">tpie::arity_t</a></div><div class="ttdeci">TPIE_OS_SIZE_T arity_t</div><div class="ttdoc">Intended to signal the number of input streams in a merge.</div><div class="ttdef"><b>Definition:</b> <a href="sort__manager_8h_source.html#l00051">sort_manager.h:51</a></div></div>
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
      <li class="footer">from TPIE 4739728 (<a href="//github.com/thomasmoelhave/tpie/tree/4739728">browse source</a>). Generated on Mon May 23 2022 23:38:36 by
<a href="http://www.doxygen.org/index.html">Doxygen</a> 1.8.17 </li>
    </ul>
  </div>
</body>
</html>
